<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VendiCasa | Valutazione Professionale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .option-btn { transition: all 0.2s ease; border: 1px solid #e5e7eb; text-align: left; width: 100%; padding: 1.25rem; border-radius: 0.5rem; background: white; font-weight: 500; color: #374151; }
        .option-btn:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .option-btn.selected { border-color: #2563eb; border-width: 2px; background-color: #eff6ff; color: #1e40af; }
        
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; padding: 1.25rem; z-index: 100; }
        input[type="number"], select { width: 100%; padding: 1.25rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; outline: none; font-size: 1.125rem; }
        input:focus { border-color: #3b82f6; }
        
        .check-option { display: flex; justify-content: space-between; align-items: center; }
        .check-mark { width: 20px; height: 20px; border: 2px solid #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .selected .check-mark { background-color: #2563eb; border-color: #2563eb; }
        .selected .check-mark::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        
        #address-input::placeholder { color: #9ca3af; font-weight: 400; }

        .step[data-step="1"] { animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        #autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 1rem 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 1000; max-height: 250px; overflow-y: auto; }
        .autocomplete-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; transition: background 0.2s; }
        .autocomplete-item:hover { background-color: #f0f7ff; }
        .autocomplete-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="py-5 flex justify-center border-b border-gray-50">
        <div class="text-2xl font-bold tracking-tighter text-blue-600 uppercase">VendiCasa</div>
    </header>

    <div id="address-bar" class="bg-gray-50 py-3 border-b border-gray-100 hidden">
        <div class="max-w-2xl mx-auto px-4 flex items-center justify-center gap-2 text-sm text-gray-600">
            <span id="summary-text">Indirizzo non inserito</span>
            <button onclick="currentStep=1; updateUI();" class="text-blue-600 underline font-semibold ml-1">Modifica</button>
        </div>
    </div>

    <main class="flex-grow flex flex-col items-center pt-10 px-4 pb-32">
        <div class="w-full max-w-xl">
            <form id="valuationForm">
                
                <div class="step active" data-step="1">
                    <div class="text-center mb-10">
                        <span class="bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest">Servizio Gratuito</span>
                        <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900 mt-4 mb-6 leading-tight">
                            Scopri il valore reale della tua casa <span class="text-blue-600">al miglior prezzo.</span>
                        </h1>
                        <p class="text-lg text-gray-600 max-w-lg mx-auto">
                            Ottieni una valutazione professionale basata sui prezzi reali di vendita del tuo quartiere.
                        </p>
                    </div>

                    <div class="relative max-w-lg mx-auto mb-10">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
                            <span class="text-xl">üìç</span>
                        </div>
                        <input type="text" id="address-input" 
                               placeholder="Inserisci indirizzo (es: Via Roma 1...)" 
                               autocomplete="off"
                               class="w-full p-6 pl-12 text-lg border-2 border-gray-100 rounded-2xl shadow-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition-all outline-none relative z-0">
                        <div id="autocomplete-list"></div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 max-w-lg mx-auto border-t border-gray-100 pt-8">
                        <div class="text-center">
                            <div class="text-xl mb-1">‚è±Ô∏è</div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter leading-3">Richiede<br>2 minuti</p>
                        </div>
                        <div class="text-center">
                            <div class="text-xl mb-1">üìä</div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter leading-3">Dati OMI<br>Aggiornati</p>
                        </div>
                        <div class="text-center">
                            <div class="text-xl mb-1">üîí</div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter leading-3">Privacy<br>Garantita</p>
                        </div>
                    </div>
                </div>

                <div class="step" data-step="2">
                    <h1 class="text-2xl md:text-3xl font-bold text-center mb-8">Di che tipo di casa si tratta?</h1>
                    <div class="space-y-3">
                        <button type="button" onclick="handleSelection(this, 'appartamento')" class="option-btn rounded-lg">Appartamento</button>
                        <button type="button" onclick="handleSelection(this, 'loft')" class="option-btn rounded-lg">Loft</button>
                        <button type="button" onclick="handleSelection(this, 'attico')" class="option-btn rounded-lg">Attico</button>
                        <button type="button" onclick="handleSelection(this, 'mansarda')" class="option-btn rounded-lg">Mansarda</button>
                        <button type="button" onclick="handleSelection(this, 'villetta-schiera')" class="option-btn rounded-lg">Villetta a schiera</button>
                        <button type="button" onclick="handleSelection(this, 'villa-indipendente')" class="option-btn rounded-lg">Villa indipendente</button>
                    </div>
                </div>

                <div class="step" data-step="3">
                    <h1 class="text-2xl md:text-3xl font-bold text-center mb-8">Quanto √® grande?</h1>
                    <div class="space-y-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-500 uppercase mb-3">Superficie totale</label>
                            <input type="number" id="mq" placeholder="Metri quadri (es. 90)" class="w-full p-5 border rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-500 uppercase mb-3">Quanti locali ha?</label>
                            <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">1</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">2</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">3</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">4</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">5</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">6+</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-500 uppercase mb-3">Quanti bagni ha?</label>
                            <div class="grid grid-cols-4 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">1</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">2</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">3</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-base rounded-lg">4+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step" data-step="4">
                    <h1 id="piani-title" class="text-2xl md:text-3xl font-bold text-center mb-8">Quanti piani ci sono nell'edificio?</h1>
                    <div class="space-y-8">
                        <div>
                            <label id="piani-label-1" class="block text-sm font-semibold text-gray-500 uppercase mb-3">Totale piani</label>
                            <div class="grid grid-cols-5 gap-2" id="totale-piani-container"></div>
                        </div>
                        <div id="piano-specifico-box" class="hidden opacity-0 transition-opacity duration-500">
                            <label class="block text-sm font-semibold text-gray-500 uppercase mb-3">A che piano si trova la casa?</label>
                            <div class="grid grid-cols-5 gap-2" id="piano-singolo-container"></div>
                        </div>
                    </div>
                </div>

<div class="step" data-step="5">
    <h1 class="text-2xl md:text-3xl font-bold text-center mb-8">Stato dell'immobile</h1>
    
    <div class="mb-8">
        <label class="block text-sm font-semibold text-gray-500 uppercase mb-3 text-center">In che condizioni √® la casa?</label>
        <div class="grid grid-cols-2 gap-2">
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm rounded-lg">Da ristrutturare</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm rounded-lg">Abitabile</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm rounded-lg">Ristrutturato</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm rounded-lg">Nuova Costruzione</button>
        </div>
    </div>

    <div>
        <label class="block text-sm font-semibold text-gray-500 uppercase mb-3 text-center">Classe Energetica</label>
        <div class="grid grid-cols-4 gap-2">
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">A4</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">A3</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">A2</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">A1</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">B</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">C</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">D</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">E</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">F</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">G</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-sm rounded-lg">H</button>
            <button type="button" onclick="selectGrid(this)" class="option-btn !p-2 text-center !text-xs rounded-lg">Non so</button>
        </div>
    </div>
</div>

<div class="step" data-step="6">
    <h1 class="text-2xl md:text-3xl font-bold text-center mb-8">Dettagli aggiuntivi</h1>
    <div class="space-y-8">
        <div id="ascensore-box" class="hidden">
            <label class="block text-sm font-semibold text-gray-400 uppercase mb-3 text-center tracking-wider">C'√® un ascensore?</label>
            <div class="grid grid-cols-2 gap-3">
                <button type="button" onclick="selectGrid(this)" class="option-btn !text-center rounded-lg">S√¨</button>
                <button type="button" onclick="selectGrid(this)" class="option-btn !text-center rounded-lg">No</button>
            </div>
        </div>
        <div>
            <label class="block text-sm font-semibold text-gray-400 uppercase mb-3 text-center tracking-wider">Pertinenze incluse</label>
            <div class="space-y-2">
                <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option rounded-lg"><span>Balcone</span><div class="check-mark"></div></button>
                <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option rounded-lg"><span>Terrazzo</span><div class="check-mark"></div></button>
                <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option rounded-lg"><span>Giardino</span><div class="check-mark"></div></button>
                <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option rounded-lg"><span>Box Auto</span><div class="check-mark"></div></button>
                <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option rounded-lg"><span>Cantina</span><div class="check-mark"></div></button>
            </div>
        </div>
    </div>
</div>

<div class="step" data-step="7">
    <h1 class="text-2xl md:text-3xl font-bold text-center mb-2">Ci siamo quasi!</h1>
    <div class="flex items-center gap-4 p-4 bg-blue-50 rounded-xl mb-6 border border-blue-100">
        <div class="text-2xl">üìä</div>
        <div class="text-sm text-blue-800">
            <strong>Analisi completata!</strong> Abbiamo incrociato i dati con <strong id="random-count">--</strong> <strong>immobili simili</strong> a <span id="city-placeholder">Trezzano</span>.
        </div>
    </div>
    <div class="space-y-4">
        <input type="text" id="nome" placeholder="Nome e Cognome" class="w-full p-4 border rounded-lg outline-none focus:border-blue-600">
        <input type="email" id="email" placeholder="Email" class="w-full p-4 border rounded-lg outline-none focus:border-blue-600">
        <input type="tel" id="telefono" placeholder="Telefono" class="w-full p-4 border rounded-lg outline-none focus:border-blue-600">
    </div>
</div>

            </form>
        </div>
    </main>

    <footer class="footer-nav">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <button id="prevBtn" onclick="prevStep()" class="px-8 py-3 border border-gray-900 rounded font-semibold text-gray-900">Indietro</button>
            <button id="nextBtn" onclick="nextStep()" class="px-10 py-3 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700">Avanti</button>
        </div>
    </footer>

<script>
let currentStep = 1;
const totalSteps = 7;
let selectedTipo = "";
let debounceTimer;
let citySelected = "tua zona"; // VARIABILE GLOBALE FISSA

const MAPBOX_TOKEN = 'pk.eyJ1IjoiY3Jpdml0dCIsImEiOiJjbWphM3hqbWMwMWQ1M2RzODhhaDlpb2Q3In0.CA7JXYd4yCnraCL8uYzcvQ';

window.onload = () => {
    generateTotalePiani();
    updateUI();
};

function generateTotalePiani() {
    const container = document.getElementById('totale-piani-container');
    if (!container) return;
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-base rounded-lg';
        btn.innerText = i === 10 ? '10+' : i;
        btn.onclick = () => handleTotalePiani(i, btn);
        container.appendChild(btn);
    }
}

const addressInput = document.getElementById('address-input');
const autocompleteList = document.getElementById('autocomplete-list');

if (addressInput) {
    addressInput.addEventListener('input', function() {
        const query = this.value;
        clearTimeout(debounceTimer);
        if (query.length < 3) {
            if (autocompleteList) autocompleteList.innerHTML = '';
            return;
        }

        debounceTimer = setTimeout(() => {
            // Ricerca universale Mapbox (rimosso proximity specifico)
            const lng = 9.0610;
            const lat = 45.4262;
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&autocomplete=true&countries=it&types=address,postcode,place&limit=5&language=it&proximity=${lng},${lat}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!autocompleteList) return;
                    autocompleteList.innerHTML = '';
                    if (!data.features) return;

                    data.features.forEach(feature => {
                        const street = feature.text;
                        const houseNumber = feature.address || "";
                        const cityContext = feature.context.find(c => c.id.startsWith('place'));
                        const city = cityContext ? cityContext.text : "";

                        let cleanAddress = houseNumber ? `${street} ${houseNumber}` : street;
                        if (city) cleanAddress += `, ${city}`;

                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.innerHTML = `<span>${cleanAddress}</span>`;
                        
                        div.onclick = () => {
                            addressInput.value = cleanAddress;
                            citySelected = city || "tua zona"; // ASSEGNAZIONE ALLA GLOBALE
                            autocompleteList.innerHTML = '';
                            document.activeElement.blur();
                            nextStep();
                        };
                        autocompleteList.appendChild(div);
                    });
                });
        }, 200);
    });
}

function handleSelection(btn, value) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(s => s.classList.remove('selected'));
    btn.classList.add('selected');
    if (currentStep === 2) selectedTipo = value;
    setTimeout(() => { nextStep(); }, 400);
}

function selectGrid(btn) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
}

function toggleMultiple(btn) { btn.classList.toggle('selected'); }

function handleTotalePiani(num, btn) {
    document.getElementById('totale-piani-container').querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const isVilla = ['villa-indipendente', 'villetta-schiera'].includes(selectedTipo);
    const pianoBox = document.getElementById('piano-specifico-box');
    if (isVilla) { pianoBox.classList.add('hidden'); setTimeout(() => nextStep(), 400); }
    else { generatePianoSingolo(num); pianoBox.classList.remove('hidden'); setTimeout(() => pianoBox.classList.add('opacity-100'), 50); }
}

function generatePianoSingolo(max) {
    const container = document.getElementById('piano-singolo-container');
    container.innerHTML = '';
    const limit = max === 10 ? 10 : max;
    for (let i = 0; i <= limit; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-base rounded-lg';
        btn.innerText = i === 0 ? 'T' : (i === 10 ? '10+' : i);
        btn.onclick = () => {
            container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            setTimeout(() => nextStep(), 400);
        };
        container.appendChild(btn);
    }
}

function handleAscensore(btn) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    setTimeout(() => nextStep(), 400);
}

function nextStep() {
    if (currentStep === totalSteps) {
        if (!document.getElementById('email').value) { alert("Inserisci i dati per la valutazione."); return; }
        showLoadingAndResults();
        return;
    }
    currentStep++;
    updateUI();
}

function prevStep() { if (currentStep > 1) { currentStep--; updateUI(); } }

function updateUI() {
    // 1. Gestione visibilit√† degli step
    document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active');
        if (parseInt(s.getAttribute('data-step')) === currentStep) s.classList.add('active');
    });

    // 2. Gestione Barra Indirizzo in alto
    const addrBar = document.getElementById('address-bar');
    if (currentStep > 1) {
        addrBar.classList.remove('hidden');
        document.getElementById('summary-text').innerText = document.getElementById('address-input').value;
    } else { 
        addrBar.classList.add('hidden'); 
    }

    // 3. FIX RANDOM COUNT E CITY (Ora allo Step 7)
    if (currentStep === 7) {
        const countEl = document.getElementById('random-count');
        const cityEl = document.getElementById('city-placeholder');
        
        // Genera il numero casuale solo se non √® gi√† stato generato
        if (countEl && (countEl.innerText === "--" || countEl.innerText === "")) {
            countEl.innerText = Math.floor(Math.random() * 9) + 9;
        }
        
        // Aggiorna il nome della citt√† nel testo di riepilogo finale
        if (cityEl) {
            cityEl.innerText = citySelected;
        }
    }

    // 4. Gestione pulsante Indietro
    document.getElementById('prevBtn').style.visibility = currentStep === 1 ? 'hidden' : 'visible';
    
    // 5. Scroll in alto automatico ad ogni cambio step
    window.scrollTo(0,0);
}

function showLoadingAndResults() {
    const main = document.querySelector('main');
    main.innerHTML = `<div class="w-full max-w-xl text-center py-20"><div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-6"></div><h2 class="text-2xl font-bold mb-2">Analisi AI in corso...</h2><p id="loading-msg" class="text-gray-500">Recupero prezzi di mercato...</p></div>`;
    document.querySelector('.footer-nav').style.display = 'none';
    
    const msgs = [
        `Analisi del mercato a ${citySelected}...`, 
        "Incrocio dati catastali...", 
        "Generazione report finale..."
    ];
    
    let i = 0;
    const interval = setInterval(() => {
        if (i < msgs.length) document.getElementById('loading-msg').innerText = msgs[i++];
        else {
            clearInterval(interval);
            main.innerHTML = `<div class="text-center py-20"><h2 class="text-3xl font-bold text-blue-600 mb-4">Ottimo lavoro!</h2><p class="text-gray-600 text-lg">La valutazione per l'immobile a ${citySelected} √® pronta.<br><br>Controlla la tua email per il report completo.</p></div>`;
        }
    }, 1500);
}

document.addEventListener('click', (e) => {
    if (e.target !== addressInput && autocompleteList) autocompleteList.innerHTML = '';
});
</script>

</body>
</html>