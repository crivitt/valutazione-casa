<!DOCTYPE html>
<html lang="it">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17824143507"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-17824143507');
    </script>
        
    <!-- Google Ads Conversion Snippet -->
    <script>
    function gtag_report_conversion(url) {
      var callback = function () {
        if (typeof(url) != 'undefined') {
          window.location = url;
        }
      };
      if (typeof gtag === 'function') {
          gtag('event', 'conversion', {
              'send_to': 'AW-17824143507/nXTzCKbb_9UbEJOxm7NC',
              'event_callback': callback
          });
      }
      return false;
    }
    </script>
        
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>vendereCASA.ai | Valutazione Professionale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    

</head>
<body class="flex flex-col min-h-screen">

    <header class="py-6 flex justify-center bg-transparent">
        <div class="text-2xl font-black tracking-tighter text-slate-900 uppercase">
            vendere<span class="text-indigo-600">CASA</span>.ai
        </div>
    </header>

    <div id="address-bar" class="bg-white/80 backdrop-blur-md py-4 border-b border-gray-100 hidden sticky top-0 z-50">
        <div class="max-w-2xl mx-auto px-6 flex items-start justify-center gap-3 text-sm">
            <span class="text-indigo-500 mt-0.5">üìç</span>
            <div class="flex flex-col items-center text-center w-full">
                <span id="summary-text" class="font-semibold text-gray-800 leading-tight block w-full px-2 text-center">Indirizzo...</span>
                <button onclick="currentStep=1; updateUI();" class="text-indigo-600 text-xs underline font-bold mt-1 hover:text-indigo-800">Modifica indirizzo</button>
            </div>
        </div>
    </div>

    <main class="flex-grow flex flex-col items-center pt-6 px-4 pb-32">
        
        <!-- Homepage -->
        <div id="home-content" class="w-full max-w-4xl text-center">
            <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight text-slate-900 leading-[1.1]">
                Vendi casa in un <span class="text-violet-600 italic">click.</span>
            </h1>
            <p class="text-lg md:text-xl text-slate-600 mb-12 max-w-2xl mx-auto">
                Ottieni una valutazione immediata basata sui dati reali del mercato immobiliare attraverso la nostra AI.
            </p>

            <div class="max-w-3xl mx-auto w-full relative">
                <div class="flex flex-row items-stretch gap-3 md:gap-4 search-stack">
                    <div id="main-search-container" class="floating-element home-shadow search-wrapper uniform-height min-w-0" onfocusin="this.classList.add('focused')" onfocusout="this.classList.remove('focused')">
                        <div class="flex-grow relative min-w-0 h-full flex items-center">
                            <input type="text" id="google-search" placeholder="Indirizzo della tua casa..." class="w-full text-base md:text-lg placeholder:text-slate-400 outline-none truncate bg-transparent">
                        </div>
                        <div id="civico-input-container" class="hidden sm:flex">
                            <input type="text" id="civico-input-main-desktop" placeholder="Civico" maxlength="6" class="outline-none placeholder:text-slate-400 text-slate-700">
                        </div>
                    </div>
                    <div id="civico-mobile-container" class="hidden sm:hidden w-full transition-all duration-300">
                         <div class="floating-element home-shadow uniform-height flex items-center px-0" id="civico-mobile-wrapper">
                            <input type="text" id="civico-input-main-mobile" placeholder="Inserisci il numero civico..." maxlength="10" class="w-full bg-transparent border-none px-6 outline-none">
                         </div>
                    </div>
                    <button id="nextBtn-mobile-full" onclick="startValuationFlow()" class="btn-gradient uniform-height flex-shrink-0 px-8 md:px-12 font-bold text-base md:text-xl whitespace-nowrap">
                        Valuta
                    </button>
                </div>
                <p id="civico-hint" class="text-xs text-amber-600 font-medium mt-4 hidden animate-fadeIn text-center">Per favore, inserisci il numero civico per una stima precisa.</p>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mt-20 max-w-5xl mx-auto px-4 text-left">
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">ü§ñ</div>
                    <h3 class="font-bold text-slate-900 mb-2">AI Predictor v2</h3>
                    <p class="text-sm text-slate-500">Analisi di migliaia di comparabili in tempo reale per una stima precisa.</p>
                </div>
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">ü§ù</div>
                    <h3 class="font-bold text-slate-900 mb-2">Agenzie Top</h3>
                    <p class="text-sm text-slate-500">Ti colleghiamo solo con il miglior partner per la tua zona specifica.</p>
                </div>
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">üõ°Ô∏è</div>
                    <h3 class="font-bold text-slate-900 mb-2">Privacy Totale</h3>
                    <p class="text-sm text-slate-500">I tuoi dati sono protetti e non verranno mai ceduti senza il tuo consenso.</p>
                </div>
            </div>
             <footer class="py-12 mt-12 text-center text-slate-400 text-sm border-t border-slate-200">
                <p>¬© 2025 vendereCASA.ai ‚Ä¢ <a href="/privacy" class="underline hover:text-violet-600">Privacy Policy</a></p>
            </footer>
        </div>

        <!-- Form Container -->
        <div id="form-container" class="w-full max-w-xl hidden">
            <div class="main-card p-6 md:p-10 bg-white">
                <form id="valuationForm" onsubmit="return false;">
                    <!-- STEP 1 -->
                    <div class="step" data-step="1">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Modifica Indirizzo</h1>
                        <div class="space-y-5">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-grow">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest text-left ml-4">Via/Piazza</label>
                                    <div class="floating-element uniform-height" id="manual-search-container">
                                        <input type="text" id="manual-route" placeholder="Cerca indirizzo..." class="floating-input">
                                    </div>
                                </div>
                                <div class="w-full sm:w-24">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest text-left ml-4">Civico</label>
                                    <div class="floating-element uniform-height">
                                        <input type="text" id="manual-civico" placeholder="es. 10" class="floating-input !px-0 text-center">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest text-left ml-4">Comune</label>
                                <div class="floating-element uniform-height">
                                    <input type="text" id="manual-city" placeholder="es. Milano" class="floating-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2 -->
                    <div class="step" data-step="2">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Tipologia immobile</h1>
                        <div class="space-y-3" id="tipo-immobile-group">
                            <button type="button" onclick="handleSelection(this, 'Appartamento')" class="option-btn text-center">Appartamento</button>
                            <button type="button" onclick="handleSelection(this, 'Loft')" class="option-btn text-center">Loft</button>
                            <button type="button" onclick="handleSelection(this, 'Attico')" class="option-btn text-center">Attico</button>
                            <button type="button" onclick="handleSelection(this, 'Mansarda')" class="option-btn text-center">Mansarda</button>
                            <button type="button" onclick="handleSelection(this, 'Villetta a schiera')" class="option-btn text-center">Villetta a schiera</button>
                            <button type="button" onclick="handleSelection(this, 'Villa indipendente')" class="option-btn text-center">Villa indipendente</button>
                        </div>
                    </div>

                    <!-- STEP 3 -->
                    <div class="step" data-step="3">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dimensioni</h1>
                        <div class="space-y-8">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Superficie (MQ)</label>
                                <div class="floating-element uniform-height max-w-[140px] mx-auto" id="mq-container">
                                    <input type="number" id="mq" placeholder="50" min="20" max="600" onblur="validateMq(this)" class="floating-input text-center text-xl !px-0">
                                </div>
                            </div>
                            <div id="locali-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Locali</label>
                                <div class="grid grid-cols-6 gap-2">
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">1</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">2</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">3</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">4</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">5</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">6+</button>
                                </div>
                            </div>
                            <div id="bagni-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Bagni</label>
                                <div class="grid grid-cols-6 gap-2">
                                    <div class="col-span-1"></div>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">1</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">2</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">3</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">4+</button>
                                    <div class="col-span-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4 -->
                    <div class="step" data-step="4">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dettagli edificio</h1>
                        <div class="space-y-8">
                            <div id="totale-piani-wrapper">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Totale piani edificio</label>
                                <div class="grid grid-cols-5 gap-2" id="totale-piani-container"></div>
                            </div>
                            <div id="piano-specifico-box" class="hidden opacity-0 transition-opacity duration-500">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">A che piano si trova?</label>
                                <div class="grid grid-cols-5 gap-2" id="piano-singolo-container"></div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 5 -->
                    <div class="step" data-step="5">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Condizioni</h1>
                        <div class="mb-8" id="stato-group">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Stato di manutenzione</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Da ristrutturare</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Abitabile</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Ristrutturato</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Nuova Costruzione</button>
                            </div>
                        </div>
                        <div id="classe-group">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Classe Energetica</label>
                            <div class="grid grid-cols-6 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A4</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A3</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A2</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">B</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">C</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">D</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">E</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">F</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">G</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm col-span-2">Non so</button>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 6 -->
                    <div class="step" data-step="6">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dettagli aggiuntivi</h1>
                        <div class="space-y-8">
                            <div id="ascensore-box" class="hidden">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Presenza ascensore</label>
                                <div class="grid grid-cols-2 gap-3" id="ascensore-group">
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !text-center">S√¨</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !text-center">No</button>
                                </div>
                            </div>
                            <div id="pertinenze-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Pertinenze incluse</label>
                                <div class="space-y-3">
                                    <button type="button" data-val="Balcone" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Balcone</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Terrazzo" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Terrazzo</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Giardino" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Giardino</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Box Auto" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Box Auto</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Cantina" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Cantina</span><div class="check-mark"></div></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 7 -->
                    <div class="step" data-step="7">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-2 text-slate-900">Ci siamo quasi!</h1>
                        <div class="flex items-center gap-4 p-5 bg-indigo-50/50 rounded-2xl mb-8 border border-indigo-100">
                            <div class="text-3xl">üìä</div>
                            <div class="text-xs text-indigo-900 font-medium leading-relaxed text-left">
                                <strong>Analisi completata!</strong> Abbiamo incrociato i dati con <strong id="random-count">--</strong> immobili simili a <span id="city-placeholder" class="font-bold underline">tua zona</span>.
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="floating-element uniform-height" id="nome-container">
                                <input type="text" id="nome" placeholder="Nome e Cognome" class="floating-input" oninput="this.parentElement.classList.remove('error-shake')">
                            </div>
                            <div class="flex flex-col gap-1">
                                <div class="floating-element uniform-height" id="email-container">
                                    <input type="email" id="email" placeholder="Email" class="floating-input" oninput="handleEmailInput(this)">
                                </div>
                                <p id="email-error-msg" class="text-[11px] text-red-500 font-bold ml-6 mt-1 hidden text-left">Inserisci un indirizzo e-mail valido</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <div class="floating-element uniform-height" id="telefono-container">
                                    <input type="tel" id="telefono" placeholder="Cellulare" maxlength="10" class="floating-input" oninput="handlePhoneInput(this)">
                                </div>
                                <p id="phone-error-msg" class="text-[11px] text-red-500 font-bold ml-6 mt-1 hidden text-left">Inserisci un numero di cellulare valido</p>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-3xl border border-slate-100" id="privacy-container">
                                <input type="checkbox" id="privacy" class="w-5 h-5 accent-indigo-600 cursor-pointer shrink-0" onchange="this.parentElement.classList.remove('error-shake')">
                                <label for="privacy" class="text-xs text-slate-500 leading-relaxed text-left">
                                    Accetto la <a href="/privacy" target="_blank" class="text-indigo-600 font-bold hover:underline">Privacy Policy</a> e acconsento al trattamento dei dati.
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer Nav -->
            <div id="nav-wrapper" class="footer-nav">
                <div class="max-w-2xl mx-auto flex justify-between items-center px-2">
                    <button id="prevBtn" onclick="prevStep()" class="px-8 py-4 font-semibold text-slate-500 hover:text-indigo-600 transition-all text-lg flex items-center gap-2 group">
                        <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> Indietro
                    </button>
                    <button id="nextBtn" onclick="nextStep()" class="btn-gradient px-8 py-4 font-bold text-lg">Avanti</button>
                </div>
            </div>
        </div>
    </main>

<script>
let currentStep = 1;
const totalSteps = 7;
let selectedTipo = "";
let citySelected = "tua zona";
let selectedAddress = "";
let addressComponents = { route: "", streetNumber: "", city: "" };
let hasCivico = false;
let cachedRandomCount = null;

const searchInput = document.getElementById('google-search');
const civicoInputDesktop = document.getElementById('civico-input-main-desktop');
const civicoInputMobile = document.getElementById('civico-input-main-mobile');

function loadGoogleMaps() {
    const apiKey = 'AIzaSyBa00KZlYGDZ-siXFKuQs33Z5LohuC8R5k';
    if (window.google && window.google.maps) { initGoogleMaps(); return; }
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
    script.async = true; script.defer = true;
    script.onload = () => { setTimeout(initGoogleMaps, 100); };
    document.head.appendChild(script);
}

function initGoogleMaps() {
    const options = { componentRestrictions: { country: "it" }, fields: ["address_components", "formatted_address"], types: ["address"] };
    if (searchInput) {
        const autocompleteMain = new google.maps.places.Autocomplete(searchInput, options);
        setupAutocompleteListener(autocompleteMain, false);
    }
    const manualInput = document.getElementById('manual-route');
    if (manualInput) {
        const autocompleteManual = new google.maps.places.Autocomplete(manualInput, options);
        setupAutocompleteListener(autocompleteManual, true);
    }
}

function setupAutocompleteListener(autocomplete, isManualStep) {
    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.address_components) return;
        
        let city = "", route = "", streetNumber = "";
        place.address_components.forEach(component => {
            const type = component.types[0];
            if (type === "street_number") streetNumber = component.long_name;
            else if (type === "route") route = component.long_name;
            else if (type === "locality") city = component.long_name;
        });

        citySelected = city || "tua zona";
        selectedAddress = place.formatted_address;
        hasCivico = !!streetNumber;
        addressComponents = { route, streetNumber, city };

        if (isManualStep) {
            document.getElementById('manual-route').value = route;
            document.getElementById('manual-civico').value = streetNumber;
            document.getElementById('manual-city').value = city;
        } else {
            if (!hasCivico) {
                showCivicoField();
            } else {
                setTimeout(() => startValuationFlow(), 300);
            }
        }
    });
}

function showCivicoField() {
    if (window.innerWidth <= 640) {
        document.getElementById('civico-mobile-container').classList.remove('hidden');
        civicoInputMobile.focus();
    } else {
        document.getElementById('civico-input-container').classList.add('visible');
        civicoInputDesktop.focus();
    }
    document.getElementById('civico-hint').classList.remove('hidden');
}


function startValuationFlow() {
    const manualCiv = (window.innerWidth <= 640) ? civicoInputMobile.value.trim() : civicoInputDesktop.value.trim();
    
    if (!hasCivico && !manualCiv) {
        const target = (window.innerWidth <= 640) ? civicoInputMobile : civicoInputDesktop;
        const container = (window.innerWidth <= 640) ? document.getElementById('civico-mobile-wrapper') : document.getElementById('civico-input-container');
        
        if (container) {
            container.classList.add('error-shake');
            setTimeout(() => container.classList.remove('error-shake'), 400);
        }
        target.focus();
        return;
    }

    if (manualCiv) {
        addressComponents.streetNumber = manualCiv;
        if (selectedAddress && !selectedAddress.includes(manualCiv)) {
             selectedAddress = selectedAddress.replace(addressComponents.route, addressComponents.route + " " + manualCiv);
        }
    }

    document.getElementById('manual-route').value = addressComponents.route;
    document.getElementById('manual-civico').value = addressComponents.streetNumber;
    document.getElementById('manual-city').value = addressComponents.city;

    document.getElementById('home-content').classList.add('hidden');
    document.getElementById('form-container').classList.remove('hidden');
    document.getElementById('address-bar').classList.remove('hidden');
    
    document.getElementById('summary-text').innerText = selectedAddress || (addressComponents.route + " " + addressComponents.streetNumber + ", " + addressComponents.city);
    
    currentStep = (citySelected === "tua zona") ? 1 : 2;
    updateUI();
}

function handleSelection(btn, value) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(s => s.classList.remove('selected'));
    btn.classList.add('selected');
    if (currentStep === 2) {
        selectedTipo = value;
        const asc = document.getElementById('ascensore-box');
        if (['Villa indipendente', 'Villetta a schiera'].includes(value)) asc.classList.add('hidden');
        else asc.classList.remove('hidden');
    }
    setTimeout(() => { nextStep(); }, 350);
}

function selectGrid(btn) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    
    const stepEl = btn.closest('.step');
    const selections = stepEl.querySelectorAll('.grid .selected');

    if (currentStep === 3 && selections.length === 2) setTimeout(() => nextStep(), 350);
    else if (currentStep === 5 && selections.length === 2) setTimeout(() => nextStep(), 350);
}

function toggleMultiple(btn) { btn.classList.toggle('selected'); }

function generateTotalePiani() {
    const container = document.getElementById('totale-piani-container');
    if (!container) return;
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button'); btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-sm';
        btn.innerText = i === 10 ? '10+' : i;
        btn.onclick = () => handleTotalePiani(i, btn);
        container.appendChild(btn);
    }
}

function handleTotalePiani(num, btn) {
    document.getElementById('totale-piani-container').querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const isVilla = ['Villa indipendente', 'Villetta a schiera'].includes(selectedTipo);
    const pianoBox = document.getElementById('piano-specifico-box');
    if (isVilla) { pianoBox.classList.add('hidden'); setTimeout(() => nextStep(), 350); }
    else { generatePianoSingolo(num); pianoBox.classList.remove('hidden'); setTimeout(() => pianoBox.classList.add('opacity-100'), 50); }
}

function generatePianoSingolo(max) {
    const container = document.getElementById('piano-singolo-container'); container.innerHTML = '';
    for (let i = 0; i <= (max === 10 ? 10 : max); i++) {
        const btn = document.createElement('button'); btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-sm';
        btn.innerText = i === 0 ? 'T' : (i === 10 ? '10+' : i);
        btn.onclick = () => {
            container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected'); setTimeout(() => nextStep(), 350);
        };
        container.appendChild(btn);
    }
}

function updateUI() {
    document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active');
        if (parseInt(s.getAttribute('data-step')) === currentStep) s.classList.add('active');
    });
    
    const nextBtn = document.getElementById('nextBtn');
    nextBtn.classList.remove('hidden');
    
    if (currentStep === 1) {
        document.getElementById('manual-route').value = addressComponents.route;
        document.getElementById('manual-civico').value = addressComponents.streetNumber;
        document.getElementById('manual-city').value = addressComponents.city;
    }

    if (currentStep === 7) {
        if (!cachedRandomCount) cachedRandomCount = Math.floor(Math.random() * 12) + 8;
        document.getElementById('random-count').innerText = cachedRandomCount;
        document.getElementById('city-placeholder').innerText = citySelected;
        nextBtn.innerText = "Ottieni Valutazione";
    } else { 
        nextBtn.innerText = "Avanti"; 
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function handlePhoneInput(input) {
    input.value = input.value.replace(/[^0-9]/g, '');
    input.parentElement.classList.remove('error-shake');
    document.getElementById('phone-error-msg').classList.add('hidden');
}

function handleEmailInput(input) {
    input.parentElement.classList.remove('error-shake');
    document.getElementById('email-error-msg').classList.add('hidden');
}

function validateStep() {
    const step = document.querySelector(`.step[data-step="${currentStep}"]`);
    if (currentStep === 1) {
        const route = document.getElementById('manual-route').value;
        const number = document.getElementById('manual-civico').value;
        const city = document.getElementById('manual-city').value;
        if (!route || !city || !number) {
            alert("Completa i dati dell'indirizzo");
            return false;
        }
        addressComponents = { route, streetNumber: number, city };
        selectedAddress = `${route} ${number}, ${city}`;
        citySelected = city;
        document.getElementById('summary-text').innerText = selectedAddress;
    }
    if (currentStep === 2) {
        if (!step.querySelector('.selected')) {
            document.getElementById('tipo-immobile-group').classList.add('error-shake');
            setTimeout(() => document.getElementById('tipo-immobile-group').classList.remove('error-shake'), 400);
            return false;
        }
    }
    if (currentStep === 3) {
        let valid = true;
        const mq = document.getElementById('mq').value;
        if (!mq || mq < 10) {
            document.getElementById('mq-container').classList.add('error-shake');
            setTimeout(() => document.getElementById('mq-container').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.querySelector('#locali-group .selected')) {
            document.querySelector('#locali-group').classList.add('error-shake');
            setTimeout(() => document.querySelector('#locali-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.querySelector('#bagni-group .selected')) {
            document.querySelector('#bagni-group').classList.add('error-shake');
            setTimeout(() => document.querySelector('#bagni-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        return valid;
    }
    if (currentStep === 4) {
        const isVilla = ['Villa indipendente', 'Villetta a schiera'].includes(selectedTipo);
        if (!document.querySelector('#totale-piani-container .selected')) {
            document.getElementById('totale-piani-wrapper').classList.add('error-shake');
            setTimeout(() => document.getElementById('totale-piani-wrapper').classList.remove('error-shake'), 400);
            return false;
        }
        if (!isVilla && !document.querySelector('#piano-singolo-container .selected')) {
            document.getElementById('piano-specifico-box').classList.add('error-shake');
            setTimeout(() => document.getElementById('piano-specifico-box').classList.remove('error-shake'), 400);
            return false;
        }
    }
    if (currentStep === 5) {
        let valid = true;
        if (!document.querySelector('#stato-group .selected')) {
            document.getElementById('stato-group').classList.add('error-shake');
            setTimeout(() => document.getElementById('stato-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.querySelector('#classe-group .selected')) {
            document.getElementById('classe-group').classList.add('error-shake');
            setTimeout(() => document.getElementById('classe-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        return valid;
    }
    if (currentStep === 6) {
        const isVilla = ['Villa indipendente', 'Villetta a schiera'].includes(selectedTipo);
        if (!isVilla && !document.querySelector('#ascensore-group .selected')) {
            document.getElementById('ascensore-box').classList.add('error-shake');
            setTimeout(() => document.getElementById('ascensore-box').classList.remove('error-shake'), 400);
            return false;
        }
    }
    if (currentStep === 7) {
        let valid = true;
        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const telefono = document.getElementById('telefono').value;
        const telRegex = /^3\d{8,9}$/;

        if (!document.getElementById('nome').value.trim()) {
            document.getElementById('nome-container').classList.add('error-shake');
            valid = false;
        }
        if (!emailRegex.test(email)) {
            document.getElementById('email-container').classList.add('error-shake');
            document.getElementById('email-error-msg').classList.remove('hidden');
            valid = false;
        }
        if (!telRegex.test(telefono)) {
            document.getElementById('telefono-container').classList.add('error-shake');
            document.getElementById('phone-error-msg').classList.remove('hidden');
            valid = false;
        }
        if (!document.getElementById('privacy').checked) {
            document.getElementById('privacy-container').classList.add('error-shake');
            valid = false;
        }
        return valid;
    }
    return true;
}

function nextStep() {
    if (!validateStep()) return;
    
    if (currentStep === 7) { 
        submitFinalForm(); 
        return; 
    }
    
    currentStep++; 
    updateUI();
    
    // CORRETTO: Usiamo currentStep, non stepNumber
    history.pushState({ step: currentStep }, "Step " + currentStep, "");
}

function prevStep() {
    // Invece di decrementare manualmente, usiamo la storia del browser
    // Questo attiver√† automaticamente window.onpopstate
    if (currentStep > 1) {
        history.back();
    } else {
        // Se siamo al primo step del form e premiamo indietro, 
        // torniamo alla home (se l'hai gestita con i div)
        location.reload(); 
    }
}

window.onpopstate = function(event) {
    if (event.state && event.state.step) {
        // Sincronizziamo la variabile globale e aggiorniamo l'interfaccia
        currentStep = event.state.step;
        mostraStepSenzaCreareStoria(currentStep);
    } else {
        // Ritorno alla base
        currentStep = 1;
        mostraStepSenzaCreareStoria(1);
    }
};

function mostraStepSenzaCreareStoria(n) {
    // Questa funzione aggiorna solo il lato visivo
    document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active');
        if (parseInt(s.getAttribute('data-step')) === n) {
            s.classList.add('active');
        }
    });
    
    currentStep = n;
    updateUI(); // Per aggiornare testi dei bottoni, mappe, ecc.
}

// Funzione di supporto (gi√† presente, la teniamo per compatibilit√†)
function goToStep(n) {
    currentStep = n;
    updateUI();
};

async function submitFinalForm() {
    const uniqueID = "VAL-" + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 5).toUpperCase();
    localStorage.setItem('currentValuationID', uniqueID);
    
    const pertinenze = Array.from(document.querySelectorAll('#pertinenze-group .selected'))
        .map(el => el.querySelector('span').innerText)
        .join(', ') || "Nessuna";

    const formData = {
        valuation_id: uniqueID,
        indirizzo: selectedAddress,
        citta: citySelected,
        mq: document.getElementById('mq').value,
        tipo_immobile: selectedTipo,
        locali: document.querySelector('#locali-group .selected')?.innerText || "N/D",
        bagni: document.querySelector('#bagni-group .selected')?.innerText || "N/D",
        piano: document.querySelector('#piano-singolo-container .selected')?.innerText || "Piano Terra/Casa Indipendente",
        totale_piani_edificio: document.querySelector('#totale-piani-container .selected')?.innerText || "N/D",
        stato: document.querySelector('#stato-group .selected')?.innerText || "N/D",
        classe_energetica: document.querySelector('#classe-group .selected')?.innerText || "N/D",
        ascensore: document.querySelector('#ascensore-box .selected')?.innerText || "No",
        pertinenze: pertinenze,
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        consenso_privacy: "Accettato",
        timestamp: new Date().toLocaleString("it-IT")
    };

    const main = document.querySelector('main');
    const nav = document.getElementById('nav-wrapper');
    if (nav) nav.classList.add('hidden');
    document.getElementById('address-bar').classList.add('hidden');

    main.innerHTML = `
        <div class="w-full max-w-xl text-center py-24 animate-fadeIn">
            <div class="relative inline-block mb-12">
                <div class="h-24 w-24 rounded-full border-4 border-indigo-100 border-t-indigo-600 animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-3xl ai-pulse">ü§ñ</div>
            </div>
            <h2 class="text-3xl font-black text-slate-900 mb-4">Analisi in corso...</h2>
            <p class="text-lg text-slate-500 max-w-sm mx-auto leading-relaxed">
                Il nostro <span class="text-indigo-600 font-bold">AI Predictor</span> sta analizzando i dati del mercato locale per calcolare la stima pi√π precisa.
            </p>
            <div class="mt-10 flex flex-col gap-3 max-w-xs mx-auto">
                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div class="h-full bg-indigo-600 animate-[loading_8s_ease-in-out_infinite]" style="width: 0%;"></div>
                </div>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Incrocio dati catastali e comparabili</p>
            </div>
        </div>
        <style>
            @keyframes loading {
                0% { width: 0%; } 100% { width: 98%; }
            }
        </style>
    `;

    try {
        const response = await fetch("https://hook.eu1.make.com/vypj6pof43fnqb84icw01dkapqjft4s8", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const resultData = await response.json();
            if (typeof gtag_report_conversion === 'function') gtag_report_conversion();
            showStimaFinale(resultData, formData.nome);
        } else {
            throw new Error();
        }
    } catch (e) {
        main.innerHTML = `
            <div class="text-center py-20 bg-white rounded-[2rem] p-10 shadow-lg border border-red-50 w-full max-w-xl">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-slate-900">Si √® verificato un ritardo</h2>
                <p class="text-slate-600 mt-4">Abbiamo ricevuto i tuoi dati. Riceverai la stima via email a breve.</p>
                <button onclick="location.reload()" class="btn-gradient px-10 py-4 font-bold text-lg mt-8">Torna alla Home</button>
            </div>`;
    }
}

function showStimaFinale(data, nome) {
    const main = document.querySelector('main');
    const prezzo = data.prezzo || "Calcolo...";
    
    main.innerHTML = `
        <div class="w-full max-w-2xl bg-white rounded-[2.5rem] p-8 md:p-12 shadow-2xl border border-indigo-50 text-center animate-fadeIn">
            <div class="inline-block p-4 bg-green-100 text-green-600 rounded-full mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            
            <h2 class="text-xl font-medium text-slate-600">Ottime notizie ${nome}, la tua casa vale:</h2>
            <div class="text-5xl md:text-6xl font-black text-slate-900 my-4 tracking-tight">${prezzo}</div>
            
            <div id="upload-section" class="bg-gradient-to-br from-indigo-600 to-violet-700 p-8 rounded-[2rem] my-8 text-white text-left relative overflow-hidden shadow-xl">
                <div class="relative z-10" id="upload-content">
                    <h4 class="text-xl font-bold mb-2 flex items-center gap-2">‚ú® Affina con l'AI Video</h4>
                    <p class="text-indigo-100 text-sm leading-relaxed mb-6">
                        Carica un video della casa (anche lungo). L'AI analizzer√† i dettagli per darti il prezzo definitivo.
                    </p>
                    
                    <label class="cursor-pointer inline-flex items-center justify-center bg-white text-indigo-600 px-8 py-4 rounded-full font-bold text-lg hover:bg-indigo-50 transition-all shadow-md w-full md:w-auto">
                        <input type="file" accept="video/*" capture="camera" class="hidden" onchange="handleVideoUpload(this)">
                        <span>üìπ Registra o Carica Video</span>
                    </label>
                </div>

                <div id="upload-loading" class="hidden relative z-10 text-center py-4">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent mx-auto mb-4"></div>
                    <p class="text-white font-bold">Estrazione frame e analisi AI in corso...</p>
                    <p class="text-indigo-200 text-xs mt-2">Non chiudere la pagina, potrebbe volerci un minuto.</p>
                </div>
            </div>

            <button onclick="location.reload()" class="text-slate-400 hover:text-slate-600 font-medium text-sm">Valuta un altro immobile</button>
        </div>
    `;
}

async function handleVideoUpload(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const currentID = localStorage.getItem('currentValuationID');
    const uploadContent = document.getElementById('upload-content');
    const uploadLoading = document.getElementById('upload-loading');
    
    // Troviamo il div del prezzo
    const mainPriceContainer = document.querySelector('main .text-5xl, main .text-6xl');

    uploadContent.classList.add('hidden');
    uploadLoading.classList.remove('hidden');

    try {
        const frames = await extractFrames(file);
        const payload = { valuation_id: currentID };
        frames.forEach((frame, index) => { payload[`video_frame_${index + 1}`] = frame; });
        
        const response = await fetch("https://hook.eu1.make.com/ztbaddyjfsd52kf7owu8xgnxca7eak66", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();

            if (mainPriceContainer && data.nuovo_prezzo) {
                // Estraiamo il prezzo attuale togliendo simboli non numerici
                const prezzoAttuale = parseInt(mainPriceContainer.innerText.replace(/\D/g, '')) || 0;
                const prezzoNuovo = data.nuovo_prezzo;

                // Animazione contatore
                animateValue(mainPriceContainer, prezzoAttuale, prezzoNuovo, 2000);
                mainPriceContainer.classList.add('text-indigo-600', 'transition-colors', 'duration-500');
            }

            // Box Feedback Viola (Stile Caricamento)
            document.getElementById('upload-section').innerHTML = `
                <div class="bg-gradient-to-br from-indigo-600 to-violet-700 p-8 rounded-[2rem] text-white shadow-xl animate-fadeIn">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-2xl animate-bounce">‚ú®</span>
                        <h4 class="text-xl font-bold">${data.feedback_titolo || 'Analisi Completata'}</h4>
                    </div>
                    <p class="text-indigo-100 text-sm leading-relaxed">
                        ${data.feedback_testo || 'L\'AI ha ricalcolato il valore basandosi sui dettagli rilevati nel video.'}
                    </p>
                    <div class="mt-4 pt-4 border-t border-white/10 text-[10px] uppercase tracking-widest font-bold text-indigo-200">
                        Prezzo aggiornato con AI Video Predictor
                    </div>
                </div>`;
                
        } else {
            throw new Error();
        }
    } catch (error) {
        console.error("Errore:", error);
        alert("C'√® stato un errore nell'analisi. Riprova.");
        uploadContent.classList.remove('hidden');
        uploadLoading.classList.add('hidden');
    }
}

// Funzione Helper per l'animazione del contatore
function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        // Easing out function per rendere l'animazione pi√π fluida alla fine
        const easeOutQuad = progress * (2 - progress);
        const current = Math.floor(easeOutQuad * (end - start) + start);
        obj.innerHTML = `‚Ç¨ ${current.toLocaleString('it-IT')}`;
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

async function extractFrames(videoFile) {
    return new Promise((resolve) => {
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const frames = [];
        video.src = URL.createObjectURL(videoFile);
        video.muted = true;
        video.play();

        video.onloadedmetadata = async () => {
            const duration = video.duration;
            const numberOfFrames = 12; 
            const capturePoints = [];
            for (let i = 1; i <= numberOfFrames; i++) {
                capturePoints.push((i / (numberOfFrames + 1)));
            }
            
            for (let point of capturePoints) {
                video.currentTime = duration * point;
                await new Promise(r => video.onseeked = r);
                
                const maxDim = 1024; 
                const scale = Math.min(1, maxDim / Math.max(video.videoWidth, video.videoHeight));
                canvas.width = video.videoWidth * scale;
                canvas.height = video.videoHeight * scale;
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                frames.push(canvas.toDataURL('image/jpeg', 0.6));
            }
            resolve(frames);
        };
    });
}
    
function validateMq(input) {
    let v = parseInt(input.value);
    if (v < 10) input.value = 10;
    if (v > 1000) input.value = 1000;
}

window.onload = () => {
    if (!history.state) {
        history.replaceState({ step: 1 }, "Step 1", "");
    }
    loadGoogleMaps(); 
    generateTotalePiani(); 
    updateUI(); 
};
</script>
</body>
</html>









