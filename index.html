<!DOCTYPE html>
<html lang="it">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17824143507"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-17824143507');
    </script>
        
    <!-- Google Ads Conversion Snippet -->
    <script>
    function gtag_report_conversion(url) {
      var callback = function () {
        if (typeof(url) != 'undefined') {
          window.location = url;
        }
      };
      if (typeof gtag === 'function') {
          gtag('event', 'conversion', {
              'send_to': 'AW-17824143507/nXTzCKbb_9UbEJOxm7NC',
              'event_callback': callback
          });
      }
      return false;
    }
    </script>
        
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>vendiCASA.ai | Valutazione Professionale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top right, rgba(124, 58, 237, 0.05), transparent 45%), #fcfcfd; 
            scroll-behavior: smooth;
            overflow-x: hidden;
            position: relative;
        }

        /* Texture Carta Martellata visibile */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1; /* Aumentato per visibilit√† */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            mix-blend-mode: multiply;
        }

        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .error-shake { animation: shake 0.3s ease-in-out; }

        .option-btn { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid #e2e8f0; 
            text-align: left; 
            width: 100%; 
            padding: 1.15rem 1.25rem; 
            border-radius: 9999px;
            background: white; 
            font-weight: 500; 
            color: #475569; 
            position: relative;
        }
        .option-btn:hover { border-color: #a78bfa; background-color: #f5f3ff; }
        .option-btn.selected { border-color: #7c3aed; border-width: 2px; background-color: #f5f3ff; color: #5b21b6; box-shadow: 0 4px 6px -1px rgba(124, 58, 237, 0.1); }
        
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(226, 232, 240, 0.8); padding: 1.25rem; z-index: 100; }
        
        input[type="email"], input[type="tel"], input[type="text"], input[type="number"] { 
            outline: none; transition: all 0.2s;
        }
        input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }
        
        .floating-element {
            transition: all 0.35s cubic-bezier(0.165, 0.84, 0.44, 1);
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
        }
        .home-shadow {
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0, 0, 0, 0.08);
        }
        .floating-element.focused {
            border-color: #c4b5fd;
            box-shadow: 0 20px 45px -10px rgba(124, 58, 237, 0.2);
        }
        .floating-input {
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
            width: 100%;
            height: 100%;
            outline: none;
            padding: 0 1.5rem !important;
            font-weight: 400;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .check-option { display: flex; justify-content: space-between; align-items: center; border-radius: 9999px !important; }
        .check-mark { width: 22px; height: 22px; border: 2px solid #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .selected .check-mark { background-color: #7c3aed; border-color: #7c3aed; }
        .selected .check-mark::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        
        .btn-gradient {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            border-radius: 9999px;
            color: white;
            transition: box-shadow 0.2s, background 0.2s;
            box-shadow: 0 15px 35px -5px rgba(124, 58, 237, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-gradient:hover {
            box-shadow: 0 20px 40px -8px rgba(124, 58, 237, 0.4);
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        .main-card { background: white; border-radius: 2rem; box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05); border: 1px solid rgba(226, 232, 240, 0.8); }

        .search-wrapper {
            padding: 0 1.5rem;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .uniform-height {
            height: 4rem; 
        }

        .pac-container {
            border-radius: 1.25rem;
            margin-top: 12px;
            border: none !important;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            font-family: 'Inter', sans-serif;
            z-index: 9999 !important;
        }
        .pac-item { padding: 14px 20px; cursor: pointer; border-top: none !important; display: flex; align-items: center; }
        .pac-item:hover { background-color: #f8fafc; }
        .pac-item-query { font-size: 1rem; color: #1e293b !important; font-weight: 600; }
        .pac-icon { display: none; }
        .hdpi .pac-logo:after, .pac-logo:after { display: none !important; }

        #google-search {
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
            height: 100%;
            padding: 0 !important;
            color: #1e293b;
        }

        #civico-input-main-desktop {
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
            font-weight: 400 !important;
            width: 80px !important;
            text-align: right;
            padding-right: 0.5rem !important;
        }

        #civico-input-container {
            transition: all 0.3s ease;
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            height: 100%;
        }
        
        #civico-input-container.visible {
            max-width: 100px;
            opacity: 1;
        }

        /* Styles per caricamento stima */
        .ai-pulse {
            animation: ai-pulse 2s infinite;
        }
        @keyframes ai-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @media (max-width: 640px) {
            .search-wrapper {
                padding: 0 1.5rem !important;
                width: 100%;
            }
            .uniform-height {
                height: 3.5rem; 
            }
            #google-search {
                font-size: 1rem;
            }
            
            .search-stack {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            #civico-mobile-container {
                width: 100%;
            }

            #civico-mobile-wrapper {
                width: 100% !important;
                padding: 0 1.5rem !important;
            }

            #civico-input-main-mobile {
                width: 100% !important;
                height: 100% !important;
                background: transparent !important;
                border: none !important;
                outline: none !important;
                box-shadow: none !important;
                font-weight: 400 !important;
                font-size: 1rem !important;
                color: #1e293b;
                padding: 0 !important;
            }
            
            #civico-mobile-wrapper.focused {
                border-color: #c4b5fd;
                box-shadow: 0 20px 45px -10px rgba(124, 58, 237, 0.2);
            }

            #nextBtn-mobile-full {
                width: 100%;
                border-radius: 9999px !important;
                height: 3.5rem;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="py-6 flex justify-center bg-transparent">
        <div class="text-2xl font-black tracking-tighter text-slate-900 uppercase">
            vendi<span class="text-indigo-600">CASA</span>.ai
        </div>
    </header>

    <div id="address-bar" class="bg-white/80 backdrop-blur-md py-4 border-b border-gray-100 hidden sticky top-0 z-50">
        <div class="max-w-2xl mx-auto px-6 flex items-start justify-center gap-3 text-sm">
            <span class="text-indigo-500 mt-0.5">üìç</span>
            <div class="flex flex-col items-center text-center w-full">
                <span id="summary-text" class="font-semibold text-gray-800 leading-tight block w-full px-2 text-center">Indirizzo...</span>
                <button onclick="currentStep=1; updateUI();" class="text-indigo-600 text-xs underline font-bold mt-1 hover:text-indigo-800">Modifica indirizzo</button>
            </div>
        </div>
    </div>

    <main class="flex-grow flex flex-col items-center pt-6 px-4 pb-32">
        
        <!-- Homepage -->
        <div id="home-content" class="w-full max-w-4xl text-center">
            <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight text-slate-900 leading-[1.1]">
                Vendi casa in un <span class="text-violet-600 italic">click.</span>
            </h1>
            <p class="text-lg md:text-xl text-slate-600 mb-12 max-w-2xl mx-auto">
                Ottieni una valutazione immediata basata sui dati reali del mercato immobiliare attraverso la nostra AI.
            </p>

            <div class="max-w-3xl mx-auto w-full relative">
                <div class="flex flex-row items-stretch gap-3 md:gap-4 search-stack">
                    <div id="main-search-container" class="floating-element home-shadow search-wrapper uniform-height min-w-0" onfocusin="this.classList.add('focused')" onfocusout="this.classList.remove('focused')">
                        <div class="flex-grow relative min-w-0 h-full flex items-center">
                            <input type="text" id="google-search" placeholder="Indirizzo della tua casa..." class="w-full text-base md:text-lg placeholder:text-slate-400 outline-none truncate bg-transparent">
                        </div>
                        <div id="civico-input-container" class="hidden sm:flex">
                            <input type="text" id="civico-input-main-desktop" placeholder="Civico" maxlength="6" class="outline-none placeholder:text-slate-400 text-slate-700">
                        </div>
                    </div>
                    <div id="civico-mobile-container" class="hidden sm:hidden w-full transition-all duration-300">
                         <div class="floating-element home-shadow uniform-height flex items-center px-0" id="civico-mobile-wrapper">
                            <input type="text" id="civico-input-main-mobile" placeholder="Inserisci il numero civico..." maxlength="10" class="w-full bg-transparent border-none px-6 outline-none">
                         </div>
                    </div>
                    <button id="nextBtn-mobile-full" onclick="startValuationFlow()" class="btn-gradient uniform-height flex-shrink-0 px-8 md:px-12 font-bold text-base md:text-xl whitespace-nowrap">
                        Valuta
                    </button>
                </div>
                <p id="civico-hint" class="text-xs text-amber-600 font-medium mt-4 hidden animate-fadeIn text-center">Per favore, inserisci il numero civico per una stima precisa.</p>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mt-20 max-w-5xl mx-auto px-4 text-left">
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">ü§ñ</div>
                    <h3 class="font-bold text-slate-900 mb-2">AI Predictor v2</h3>
                    <p class="text-sm text-slate-500">Analisi di migliaia di comparabili in tempo reale per una stima precisa.</p>
                </div>
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">ü§ù</div>
                    <h3 class="font-bold text-slate-900 mb-2">Agenzie Top</h3>
                    <p class="text-sm text-slate-500">Ti colleghiamo solo con il miglior partner per la tua zona specifica.</p>
                </div>
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">üõ°Ô∏è</div>
                    <h3 class="font-bold text-slate-900 mb-2">Privacy Totale</h3>
                    <p class="text-sm text-slate-500">I tuoi dati sono protetti e non verranno mai ceduti senza il tuo consenso.</p>
                </div>
            </div>
             <footer class="py-12 mt-12 text-center text-slate-400 text-sm border-t border-slate-200">
                <p>¬© 2025 vendiCASA.ai ‚Ä¢ <a href="/privacy" class="underline hover:text-violet-600">Privacy Policy</a></p>
            </footer>
        </div>

        <!-- Form Container -->
        <div id="form-container" class="w-full max-w-xl hidden">
            <div class="main-card p-6 md:p-10 bg-white">
                <form id="valuationForm" onsubmit="return false;">
                    <!-- STEP 1 -->
                    <div class="step" data-step="1">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Modifica Indirizzo</h1>
                        <div class="space-y-5">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-grow">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest text-left ml-4">Via/Piazza</label>
                                    <div class="floating-element uniform-height" id="manual-search-container">
                                        <input type="text" id="manual-route" placeholder="Cerca indirizzo..." class="floating-input">
                                    </div>
                                </div>
                                <div class="w-full sm:w-24">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest text-left ml-4">Civico</label>
                                    <div class="floating-element uniform-height">
                                        <input type="text" id="manual-civico" placeholder="es. 10" class="floating-input !px-0 text-center">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest text-left ml-4">Comune</label>
                                <div class="floating-element uniform-height">
                                    <input type="text" id="manual-city" placeholder="es. Milano" class="floating-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2 -->
                    <div class="step" data-step="2">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Tipologia immobile</h1>
                        <div class="space-y-3" id="tipo-immobile-group">
                            <button type="button" onclick="handleSelection(this, 'Appartamento')" class="option-btn text-center">Appartamento</button>
                            <button type="button" onclick="handleSelection(this, 'Loft')" class="option-btn text-center">Loft</button>
                            <button type="button" onclick="handleSelection(this, 'Attico')" class="option-btn text-center">Attico</button>
                            <button type="button" onclick="handleSelection(this, 'Mansarda')" class="option-btn text-center">Mansarda</button>
                            <button type="button" onclick="handleSelection(this, 'Villetta a schiera')" class="option-btn text-center">Villetta a schiera</button>
                            <button type="button" onclick="handleSelection(this, 'Villa indipendente')" class="option-btn text-center">Villa indipendente</button>
                        </div>
                    </div>

                    <!-- STEP 3 -->
                    <div class="step" data-step="3">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dimensioni</h1>
                        <div class="space-y-8">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Superficie (MQ)</label>
                                <div class="floating-element uniform-height max-w-[140px] mx-auto" id="mq-container">
                                    <input type="number" id="mq" placeholder="50" min="20" max="600" onblur="validateMq(this)" class="floating-input text-center text-xl !px-0">
                                </div>
                            </div>
                            <div id="locali-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Locali</label>
                                <div class="grid grid-cols-6 gap-2">
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">1</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">2</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">3</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">4</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">5</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">6+</button>
                                </div>
                            </div>
                            <div id="bagni-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Bagni</label>
                                <div class="grid grid-cols-6 gap-2">
                                    <div class="col-span-1"></div>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">1</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">2</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">3</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">4</button>
                                    <div class="col-span-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4 -->
                    <div class="step" data-step="4">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dettagli edificio</h1>
                        <div class="space-y-8">
                            <div id="totale-piani-wrapper">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Totale piani edificio</label>
                                <div class="grid grid-cols-5 gap-2" id="totale-piani-container"></div>
                            </div>
                            <div id="piano-specifico-box" class="hidden opacity-0 transition-opacity duration-500">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">A che piano si trova?</label>
                                <div class="grid grid-cols-5 gap-2" id="piano-singolo-container"></div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 5 -->
                    <div class="step" data-step="5">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Condizioni</h1>
                        <div class="mb-8" id="stato-group">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Stato di manutenzione</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Da ristrutturare</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Abitabile</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Ristrutturato</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Nuova Costruzione</button>
                            </div>
                        </div>
                        <div id="classe-group">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Classe Energetica</label>
                            <div class="grid grid-cols-6 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A4</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A3</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A2</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">B</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">C</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">D</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">E</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">F</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">G</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm col-span-2">Non so</button>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 6 -->
                    <div class="step" data-step="6">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dettagli aggiuntivi</h1>
                        <div class="space-y-8">
                            <div id="ascensore-box" class="hidden">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Presenza ascensore</label>
                                <div class="grid grid-cols-2 gap-3" id="ascensore-group">
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !text-center">S√¨</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !text-center">No</button>
                                </div>
                            </div>
                            <div id="pertinenze-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Pertinenze incluse</label>
                                <div class="space-y-3">
                                    <button type="button" data-val="Balcone" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Balcone</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Terrazzo" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Terrazzo</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Giardino" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Giardino</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Box Auto" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Box Auto</span><div class="check-mark"></div></button>
                                    <button type="button" data-val="Cantina" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Cantina</span><div class="check-mark"></div></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 7 -->
                    <div class="step" data-step="7">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-2 text-slate-900">Ci siamo quasi!</h1>
                        <div class="flex items-center gap-4 p-5 bg-indigo-50/50 rounded-2xl mb-8 border border-indigo-100">
                            <div class="text-3xl">üìä</div>
                            <div class="text-xs text-indigo-900 font-medium leading-relaxed text-left">
                                <strong>Analisi completata!</strong> Abbiamo incrociato i dati con <strong id="random-count">--</strong> immobili simili a <span id="city-placeholder" class="font-bold underline">tua zona</span>.
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="floating-element uniform-height" id="nome-container">
                                <input type="text" id="nome" placeholder="Nome e Cognome" class="floating-input">
                            </div>
                            <div class="floating-element uniform-height" id="email-container">
                                <input type="email" id="email" placeholder="Email" class="floating-input">
                            </div>
                            <div class="floating-element uniform-height" id="telefono-container">
                                <input type="tel" id="telefono" placeholder="Telefono" class="floating-input">
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-3xl border border-slate-100" id="privacy-container">
                                <input type="checkbox" id="privacy" class="mt-1 w-5 h-5 accent-indigo-600 cursor-pointer shrink-0">
                                <label for="privacy" class="text-xs text-slate-500 leading-relaxed">
                                    Accetto la <a href="#" target="_blank" class="text-indigo-600 font-bold hover:underline">Privacy Policy</a> e acconsento al trattamento dei dati.
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer Nav -->
            <div id="nav-wrapper" class="footer-nav">
                <div class="max-w-2xl mx-auto flex justify-between items-center px-2">
                    <button id="prevBtn" onclick="prevStep()" class="px-8 py-4 font-semibold text-slate-500 hover:text-indigo-600 transition-all text-lg flex items-center gap-2 group">
                        <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> Indietro
                    </button>
                    <button id="nextBtn" onclick="nextStep()" class="btn-gradient px-8 py-4 font-bold text-lg">Avanti</button>
                </div>
            </div>
        </div>
    </main>

<script>
let currentStep = 1;
const totalSteps = 7;
let selectedTipo = "";
let citySelected = "tua zona";
let selectedAddress = "";
let hasCivico = false;
let cachedRandomCount = null;

const searchInput = document.getElementById('google-search');
const civicoInputDesktop = document.getElementById('civico-input-main-desktop');
const civicoInputMobile = document.getElementById('civico-input-main-mobile');

function loadGoogleMaps() {
    const apiKey = 'AIzaSyBa00KZlYGDZ-siXFKuQs33Z5LohuC8R5k';
    if (window.google && window.google.maps) { initGoogleMaps(); return; }
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
    script.async = true; script.defer = true;
    script.onload = () => { setTimeout(initGoogleMaps, 100); };
    document.head.appendChild(script);
}

function initGoogleMaps() {
    const options = { componentRestrictions: { country: "it" }, fields: ["address_components", "formatted_address"], types: ["address"] };
    if (searchInput) {
        const autocompleteMain = new google.maps.places.Autocomplete(searchInput, options);
        setupAutocompleteListener(autocompleteMain, false);
    }
    const manualInput = document.getElementById('manual-route');
    if (manualInput) {
        const autocompleteManual = new google.maps.places.Autocomplete(manualInput, options);
        setupAutocompleteListener(autocompleteManual, true);
    }
}

function setupAutocompleteListener(autocomplete, isManualStep) {
    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.address_components) return;
        let city = "", route = "", streetNumber = "";
        for (const component of place.address_components) {
            const type = component.types[0];
            if (type === "street_number") streetNumber = component.long_name;
            else if (type === "route") route = component.long_name;
            else if (type === "locality") city = component.long_name;
        }
        citySelected = city || "tua zona";
        selectedAddress = place.formatted_address;
        hasCivico = !!streetNumber;

        if (isManualStep) {
            document.getElementById('manual-route').value = route;
            document.getElementById('manual-civico').value = streetNumber;
            document.getElementById('manual-city').value = city;
        } else {
            if (!hasCivico) {
                showCivicoField();
            } else {
                setTimeout(() => startValuationFlow(), 300);
            }
        }
    });
}

function showCivicoField() {
    if (window.innerWidth <= 640) {
        document.getElementById('civico-mobile-container').classList.remove('hidden');
        civicoInputMobile.focus();
    } else {
        document.getElementById('civico-input-container').classList.add('visible');
        civicoInputDesktop.focus();
    }
    document.getElementById('civico-hint').classList.remove('hidden');
}

function startValuationFlow() {
    const inputVal = searchInput ? searchInput.value.trim() : '';
    if (!selectedAddress && inputVal.length < 5) return;
    
    document.getElementById('home-content').classList.add('hidden');
    document.getElementById('form-container').classList.remove('hidden');
    document.getElementById('address-bar').classList.remove('hidden');
    
    const manualCiv = (window.innerWidth <= 640) ? civicoInputMobile.value : civicoInputDesktop.value;
    if (manualCiv && !selectedAddress.includes(manualCiv)) {
        selectedAddress += " " + manualCiv;
    }

    document.getElementById('summary-text').innerText = selectedAddress || inputVal;
    currentStep = (citySelected === "tua zona") ? 1 : 2;
    updateUI();
}

function handleSelection(btn, value) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(s => s.classList.remove('selected'));
    btn.classList.add('selected');
    if (currentStep === 2) {
        selectedTipo = value;
        const asc = document.getElementById('ascensore-box');
        if (['Villa indipendente', 'Villetta a schiera'].includes(value)) asc.classList.add('hidden');
        else asc.classList.remove('hidden');
    }
    setTimeout(() => { nextStep(); }, 350);
}

function selectGrid(btn) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    
    const stepEl = btn.closest('.step');
    const grids = stepEl.querySelectorAll('.grid');
    const selections = stepEl.querySelectorAll('.grid .selected');

    if (currentStep === 3) {
        if (selections.length === 2) setTimeout(() => nextStep(), 350);
    } else if (currentStep === 5) {
        if (selections.length === 2) setTimeout(() => nextStep(), 350);
    }
}

function toggleMultiple(btn) { btn.classList.toggle('selected'); }

function generateTotalePiani() {
    const container = document.getElementById('totale-piani-container');
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button'); btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-sm';
        btn.innerText = i === 10 ? '10+' : i;
        btn.onclick = () => handleTotalePiani(i, btn);
        container.appendChild(btn);
    }
}

function handleTotalePiani(num, btn) {
    document.getElementById('totale-piani-container').querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const isVilla = ['Villa indipendente', 'Villetta a schiera'].includes(selectedTipo);
    const pianoBox = document.getElementById('piano-specifico-box');
    if (isVilla) { pianoBox.classList.add('hidden'); setTimeout(() => nextStep(), 350); }
    else { generatePianoSingolo(num); pianoBox.classList.remove('hidden'); setTimeout(() => pianoBox.classList.add('opacity-100'), 50); }
}

function generatePianoSingolo(max) {
    const container = document.getElementById('piano-singolo-container'); container.innerHTML = '';
    for (let i = 0; i <= (max === 10 ? 10 : max); i++) {
        const btn = document.createElement('button'); btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-sm';
        btn.innerText = i === 0 ? 'T' : (i === 10 ? '10+' : i);
        btn.onclick = () => {
            container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected'); setTimeout(() => nextStep(), 350);
        };
        container.appendChild(btn);
    }
}

function updateUI() {
    document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active');
        if (parseInt(s.getAttribute('data-step')) === currentStep) s.classList.add('active');
    });
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 1) nextBtn.classList.add('hidden'); else nextBtn.classList.remove('hidden');
    if (currentStep === 7) {
        if (!cachedRandomCount) cachedRandomCount = Math.floor(Math.random() * 12) + 8;
        document.getElementById('random-count').innerText = cachedRandomCount;
        document.getElementById('city-placeholder').innerText = citySelected;
        nextBtn.innerText = "Ottieni Valutazione";
    } else { nextBtn.innerText = "Avanti"; }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep() {
    const step = document.querySelector(`.step[data-step="${currentStep}"]`);
    if (currentStep === 1) {
        const route = document.getElementById('manual-route').value;
        const city = document.getElementById('manual-city').value;
        if (!route || !city) return false;
    }
    if (currentStep === 2) {
        if (!step.querySelector('.selected')) {
            document.getElementById('tipo-immobile-group').classList.add('error-shake');
            setTimeout(() => document.getElementById('tipo-immobile-group').classList.remove('error-shake'), 400);
            return false;
        }
    }
    if (currentStep === 3) {
        let valid = true;
        const mq = document.getElementById('mq').value;
        if (!mq || mq < 10) {
            document.getElementById('mq-container').classList.add('error-shake');
            setTimeout(() => document.getElementById('mq-container').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.querySelector('#locali-group .selected')) {
            document.querySelector('#locali-group').classList.add('error-shake');
            setTimeout(() => document.querySelector('#locali-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.querySelector('#bagni-group .selected')) {
            document.querySelector('#bagni-group').classList.add('error-shake');
            setTimeout(() => document.querySelector('#bagni-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        return valid;
    }
    if (currentStep === 4) {
        const isVilla = ['Villa indipendente', 'Villetta a schiera'].includes(selectedTipo);
        if (!document.querySelector('#totale-piani-container .selected')) {
            document.getElementById('totale-piani-wrapper').classList.add('error-shake');
            setTimeout(() => document.getElementById('totale-piani-wrapper').classList.remove('error-shake'), 400);
            return false;
        }
        if (!isVilla && !document.querySelector('#piano-singolo-container .selected')) {
            document.getElementById('piano-specifico-box').classList.add('error-shake');
            setTimeout(() => document.getElementById('piano-specifico-box').classList.remove('error-shake'), 400);
            return false;
        }
    }
    if (currentStep === 5) {
        let valid = true;
        if (!document.querySelector('#stato-group .selected')) {
            document.getElementById('stato-group').classList.add('error-shake');
            setTimeout(() => document.getElementById('stato-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.querySelector('#classe-group .selected')) {
            document.getElementById('classe-group').classList.add('error-shake');
            setTimeout(() => document.getElementById('classe-group').classList.remove('error-shake'), 400);
            valid = false;
        }
        return valid;
    }
    if (currentStep === 6) {
        const isVilla = ['Villa indipendente', 'Villetta a schiera'].includes(selectedTipo);
        if (!isVilla && !document.querySelector('#ascensore-group .selected')) {
            document.getElementById('ascensore-box').classList.add('error-shake');
            setTimeout(() => document.getElementById('ascensore-box').classList.remove('error-shake'), 400);
            return false;
        }
    }
    if (currentStep === 7) {
        let valid = true;
        const email = document.getElementById('email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!document.getElementById('nome').value) {
            document.getElementById('nome-container').classList.add('error-shake');
            setTimeout(() => document.getElementById('nome-container').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!emailRegex.test(email)) {
            document.getElementById('email-container').classList.add('error-shake');
            setTimeout(() => document.getElementById('email-container').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.getElementById('telefono').value) {
            document.getElementById('telefono-container').classList.add('error-shake');
            setTimeout(() => document.getElementById('telefono-container').classList.remove('error-shake'), 400);
            valid = false;
        }
        if (!document.getElementById('privacy').checked) {
            document.getElementById('privacy-container').classList.add('error-shake');
            setTimeout(() => document.getElementById('privacy-container').classList.remove('error-shake'), 400);
            valid = false;
        }
        return valid;
    }
    return true;
}

function nextStep() {
    if (!validateStep()) return;
    if (currentStep === 7) { submitFinalForm(); return; }
    currentStep++; updateUI();
}

function prevStep() { if (currentStep > 1) { currentStep--; updateUI(); } else { location.reload(); } }

async function submitFinalForm() {
    const pertinenze = Array.from(document.querySelectorAll('#pertinenze-group .selected'))
        .map(el => el.querySelector('span').innerText)
        .join(', ') || "Nessuna";

    const formData = {
        indirizzo: selectedAddress,
        citta: citySelected,
        mq: document.getElementById('mq').value,
        tipo_immobile: selectedTipo,
        locali: document.querySelector('#locali-group .selected')?.innerText || "N/D",
        bagni: document.querySelector('#bagni-group .selected')?.innerText || "N/D",
        piano: document.querySelector('#piano-singolo-container .selected')?.innerText || "Piano Terra/Casa Indipendente",
        totale_piani_edificio: document.querySelector('#totale-piani-container .selected')?.innerText || "N/D",
        stato: document.querySelector('#stato-group .selected')?.innerText || "N/D",
        classe_energetica: document.querySelector('#classe-group .selected')?.innerText || "N/D",
        ascensore: document.querySelector('#ascensore-box .selected')?.innerText || "N/D",
        pertinenze: pertinenze,
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        consenso_privacy: "Accettato",
        timestamp: new Date().toLocaleString("it-IT")
    };

    const main = document.querySelector('main');
    const nav = document.getElementById('nav-wrapper');
    if (nav) nav.classList.add('hidden');
    document.getElementById('address-bar').classList.add('hidden');

    // MOSTRA CARICAMENTO ANALISI AI
    main.innerHTML = `
        <div class="w-full max-w-xl text-center py-24 animate-fadeIn">
            <div class="relative inline-block mb-12">
                <div class="h-24 w-24 rounded-full border-4 border-indigo-100 border-t-indigo-600 animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-3xl ai-pulse">ü§ñ</div>
            </div>
            <h2 class="text-3xl font-black text-slate-900 mb-4">Analisi in corso...</h2>
            <p class="text-lg text-slate-500 max-w-sm mx-auto leading-relaxed">
                Il nostro <span class="text-indigo-600 font-bold">AI Predictor</span> sta analizzando i dati del mercato locale per calcolare la stima pi√π precisa.
            </p>
            <div class="mt-10 flex flex-col gap-3 max-w-xs mx-auto">
                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div class="h-full bg-indigo-600 animate-[loading_8s_ease-in-out_infinite]" style="width: 0%;"></div>
                </div>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Incrocio dati catastali e comparabili</p>
            </div>
        </div>
        <style>
            @keyframes loading {
                0% { width: 0%; }
                20% { width: 35%; }
                50% { width: 65%; }
                80% { width: 92%; }
                100% { width: 98%; }
            }
        </style>
    `;

    try {
        const response = await fetch("https://hook.eu1.make.com/vypj6pof43fnqb84icw01dkapqjft4s8", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const resultData = await response.json();
            if (typeof gtag_report_conversion === 'function') gtag_report_conversion();
            
            // MOSTRA RISULTATO FINALE CON STIMA
            showStimaFinale(resultData, formData.nome);
        } else {
            throw new Error();
        }
    } catch (e) {
        main.innerHTML = `
            <div class="text-center py-20 bg-white rounded-[2rem] p-10 shadow-lg border border-red-50 w-full max-w-xl">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-slate-900">Si √® verificato un ritardo</h2>
                <p class="text-slate-600 mt-4">Abbiamo comunque ricevuto i tuoi dati. Riceverai la stima via email tra pochi istanti.</p>
                <button onclick="location.reload()" class="btn-gradient px-10 py-4 font-bold text-lg mt-8">Torna alla Home</button>
            </div>`;
    }
}

function showStimaFinale(data, nome) {
    const main = document.querySelector('main');
    const prezzo = data.prezzo || "Calcolo...";
    const range = data.range || "";
    
    main.innerHTML = `
        <div class="w-full max-w-2xl bg-white rounded-[2.5rem] p-8 md:p-12 shadow-2xl border border-indigo-50 text-center animate-fadeIn">
            <div class="inline-block p-4 bg-green-100 text-green-600 rounded-full mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            
            <h2 class="text-xl font-medium text-slate-600">Ottime notizie ${nome}, la tua casa vale:</h2>
            <div class="text-5xl md:text-6xl font-black text-slate-900 my-4 tracking-tight">
                ‚Ç¨ ${prezzo}
            </div>
            
            ${range ? `
                <div class="mb-8">
                    <span class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-full text-sm font-bold border border-indigo-100">
                        Range stimato: ‚Ç¨ ${range}
                    </span>
                </div>
            ` : ''}
            
            <div class="bg-slate-50 p-6 rounded-3xl mb-10 text-left border border-slate-100">
                <div class="flex items-center gap-4 mb-2">
                    <div class="text-2xl">üìß</div>
                    <h4 class="font-bold text-slate-900">Analisi completa inviata!</h4>
                </div>
                <p class="text-sm text-slate-500 leading-relaxed">
                    Abbiamo inviato un <strong>Report PDF dettagliato</strong> alla tua email con i comparabili venduti e le tendenze di mercato a ${citySelected}.
                </p>
            </div>

            <div class="flex flex-col gap-4">
                <button onclick="location.reload()" class="btn-gradient w-full py-5 font-bold text-xl shadow-lg">Valuta un altro immobile</button>
                <p class="text-[11px] text-slate-400">Valutazione basata su intelligenza artificiale v2.5 e dati OMI 2024</p>
            </div>
        </div>
    `;
}

function validateMq(input) {
    let v = parseInt(input.value);
    if (v < 10) input.value = 10;
    if (v > 1000) input.value = 1000;
}

window.onload = () => { loadGoogleMaps(); generateTotalePiani(); updateUI(); };
</script>
</body>
</html>
