<!DOCTYPE html>
<html lang="it">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17824143507"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-17824143507');
    </script>
        
    <!-- Google Ads Conversion Snippet -->
    <script>
    function gtag_report_conversion(url) {
      var callback = function () {
        if (typeof(url) != 'undefined') {
          window.location = url;
        }
      };
      if (typeof gtag === 'function') {
          gtag('event', 'conversion', {
              'send_to': 'AW-17824143507/nXTzCKbb_9UbEJOxm7NC',
              'event_callback': callback
          });
      }
      return false;
    }
    </script>
        
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vendiCASA.ai | Valutazione Professionale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top right, rgba(124, 58, 237, 0.05), transparent 45%), #f8fafc; 
            scroll-behavior: smooth;
        }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        .option-btn { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid #e2e8f0; 
            text-align: left; 
            width: 100%; 
            padding: 1.15rem 1.25rem; 
            border-radius: 1rem;
            background: white; 
            font-weight: 500; 
            color: #475569; 
            position: relative;
        }
        .option-btn:hover { border-color: #a78bfa; background-color: #f5f3ff; transform: translateY(-1px); }
        .option-btn.selected { border-color: #7c3aed; border-width: 2px; background-color: #f5f3ff; color: #5b21b6; box-shadow: 0 4px 6px -1px rgba(124, 58, 237, 0.1); }
        
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(226, 232, 240, 0.8); padding: 1.25rem; z-index: 100; }
        
        input[type="number"], input[type="text"], input[type="email"], input[type="tel"] { 
            width: 100%; padding: 1.15rem 1.5rem; border: 1px solid #e2e8f0; border-radius: 1rem; outline: none; font-size: 1.05rem; background: white; transition: all 0.2s;
        }
        input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }
        
        .check-option { display: flex; justify-content: space-between; align-items: center; }
        .check-mark { width: 22px; height: 22px; border: 2px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .selected .check-mark { background-color: #7c3aed; border-color: #7c3aed; }
        .selected .check-mark::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        
        .btn-gradient {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            border-radius: 9999px;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 8px 20px -6px rgba(124, 58, 237, 0.4);
        }
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px -8px rgba(124, 58, 237, 0.5);
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        .main-card { background: white; border-radius: 2rem; box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05); border: 1px solid rgba(226, 232, 240, 0.8); }

        .search-wrapper {
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            overflow: visible;
        }
        .search-wrapper.focused {
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(124, 58, 237, 0.15), 0 10px 20px -5px rgba(0, 0, 0, 0.04);
        }

        /* Stile suggerimenti Google Maps coerente */
        .pac-container {
            border-radius: 1.25rem;
            margin-top: 12px;
            border: none !important;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            font-family: 'Inter', sans-serif;
            padding: 8px 0;
            z-index: 9999 !important;
        }
        .pac-item {
            padding: 14px 20px;
            cursor: pointer;
            border-top: none !important;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .pac-item:hover { background-color: #f8fafc; }
        
        .pac-item-query { 
            font-size: 1rem; 
            color: #1e293b !important; 
            font-weight: 600; 
            padding-right: 5px; 
        }
        .pac-matched { color: #1e293b !important; }
        .pac-item > span:last-child { color: #64748b !important; }

        .pac-icon { display: none; }
        .hdpi .pac-logo:after, .pac-logo:after { display: none !important; }

        #google-search {
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
        }

        #civico-input-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
        }
        #civico-input-container.visible {
            max-width: 140px;
            opacity: 1;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="py-6 flex justify-center bg-transparent">
        <div class="text-2xl font-black tracking-tighter text-slate-900 uppercase">
            vendi<span class="text-indigo-600">CASA</span>.ai
        </div>
    </header>

    <div id="address-bar" class="bg-white/80 backdrop-blur-md py-4 border-b border-gray-100 hidden sticky top-0 z-50">
        <div class="max-w-2xl mx-auto px-6 flex items-start justify-center gap-3 text-sm">
            <span class="text-indigo-500 mt-0.5">üìç</span>
            <div class="flex flex-col items-center text-center w-full">
                <span id="summary-text" class="font-semibold text-gray-800 leading-tight block w-full px-2">Indirizzo...</span>
                <button onclick="currentStep=1; updateUI();" class="text-indigo-600 text-xs underline font-bold mt-1 hover:text-indigo-800">Modifica indirizzo</button>
            </div>
        </div>
    </div>

    <main class="flex-grow flex flex-col items-center pt-6 px-4 pb-32">
        
        <!-- Homepage -->
        <div id="home-content" class="w-full max-w-4xl text-center">
            <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight text-slate-900">
                Vendi casa in un <span class="text-violet-600 italic">click.</span>
            </h1>
            <p class="text-lg md:text-xl text-slate-600 mb-12 max-w-2xl mx-auto">
                Ottieni una valutazione immediata basata sui dati reali del mercato immobiliare attraverso la nostra AI.
            </p>

            <div class="max-w-3xl mx-auto w-full relative">
                <div id="main-search-container" class="search-wrapper bg-white p-2 rounded-[2rem] flex flex-col md:flex-row items-center relative z-10">
                    <!-- Indirizzo -->
                    <div class="flex-grow relative w-full px-4 border-b md:border-b-0 md:border-r border-slate-100 min-w-0">
                        <input type="text" id="google-search" placeholder="Inserisci l'indirizzo della tua casa..." class="w-full text-lg py-4 placeholder:text-slate-400 outline-none truncate">
                    </div>
                    
                    <!-- Campo Civico -->
                    <div id="civico-input-container" class="w-full md:w-auto">
                        <input type="text" id="civico-input-main" placeholder="Civico" maxlength="6" class="!py-3 !px-3 !w-20 md:!w-24 text-center border border-slate-200 !rounded-xl text-lg font-semibold bg-slate-50 focus:bg-white focus:border-indigo-400">
                    </div>

                    <!-- Tasto Valuta -->
                    <div class="w-full md:w-auto p-1 md:p-0 flex-shrink-0">
                        <button onclick="startValuationFlow()" class="btn-gradient px-10 py-4 font-bold text-lg w-full md:w-auto md:min-w-[180px]">
                            Valuta ora
                        </button>
                    </div>
                </div>
                <p id="civico-hint" class="text-xs text-amber-600 font-medium mt-3 hidden animate-fadeIn">Per favore, completa l'indirizzo inserendo il numero civico.</p>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mt-20 max-w-5xl mx-auto px-4 text-left">
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">ü§ñ</div>
                    <h3 class="font-bold text-slate-900 mb-2">AI Predictor v2</h3>
                    <p class="text-sm text-slate-500">Analisi di migliaia di comparabili in tempo reale per una stima precisa.</p>
                </div>
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">ü§ù</div>
                    <h3 class="font-bold text-slate-900 mb-2">Agenzie Top</h3>
                    <p class="text-sm text-slate-500">Ti colleghiamo solo con il miglior partner per la tua zona specifica.</p>
                </div>
                <div class="p-6 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="text-3xl mb-4">üõ°Ô∏è</div>
                    <h3 class="font-bold text-slate-900 mb-2">Privacy Totale</h3>
                    <p class="text-sm text-slate-500">I tuoi dati sono al sicuro e non verranno ceduti a call center.</p>
                </div>
            </div>
            
             <footer class="py-12 mt-12 text-center text-slate-400 text-sm border-t border-slate-200">
                <p>¬© 2025 vendiCASA.ai ‚Ä¢ <a href="#" class="underline hover:text-violet-600">Informativa Privacy</a></p>
            </footer>
        </div>

        <!-- Form Container -->
        <div id="form-container" class="w-full max-w-xl hidden">
            <div class="main-card p-6 md:p-10 bg-white">
                <form id="valuationForm">
                    <!-- Step 1: Modifica Indirizzo manuale con Suggerimenti Google -->
                    <div class="step" data-step="1">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Modifica Indirizzo</h1>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">Via/Piazza</label>
                                <input type="text" id="manual-route" placeholder="Cerca indirizzo...">
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="col-span-1">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">Civico</label>
                                    <input type="text" id="manual-civico" placeholder="es. 10" class="text-center">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">Comune</label>
                                    <input type="text" id="manual-city" placeholder="es. Milano">
                                </div>
                            </div>
                            <button type="button" onclick="confirmManualAddress()" class="btn-gradient w-full py-4 font-bold text-lg mt-4">Conferma e prosegui</button>
                        </div>
                    </div>

                    <!-- Step 2: Tipologia immobile -->
                    <div class="step" data-step="2">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Tipologia immobile</h1>
                        <div class="space-y-3">
                            <button type="button" onclick="handleSelection(this, 'appartamento')" class="option-btn">Appartamento</button>
                            <button type="button" onclick="handleSelection(this, 'loft')" class="option-btn">Loft</button>
                            <button type="button" onclick="handleSelection(this, 'attico')" class="option-btn">Attico</button>
                            <button type="button" onclick="handleSelection(this, 'mansarda')" class="option-btn">Mansarda</button>
                            <button type="button" onclick="handleSelection(this, 'villetta-schiera')" class="option-btn">Villetta a schiera</button>
                            <button type="button" onclick="handleSelection(this, 'villa-indipendente')" class="option-btn">Villa indipendente</button>
                        </div>
                    </div>

                    <!-- Step 3: Dimensioni -->
                    <div class="step" data-step="3">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dimensioni</h1>
                        <div class="space-y-8">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Superficie (MQ)</label>
                                <input type="number" id="mq" placeholder="es. 95" class="text-center font-bold text-2xl">
                            </div>
                            <div id="locali-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Locali</label>
                                <div class="grid grid-cols-6 gap-2">
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">1</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">2</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">3</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">4</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">5</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">6+</button>
                                </div>
                            </div>
                            <div id="bagni-group">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Bagni</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">1</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">2</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">3</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">4+</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Dettagli edificio -->
                    <div class="step" data-step="4">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dettagli edificio</h1>
                        <div class="space-y-8">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Totale piani edificio</label>
                                <div class="grid grid-cols-5 gap-2" id="totale-piani-container"></div>
                            </div>
                            <div id="piano-specifico-box" class="hidden opacity-0 transition-opacity duration-500">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">A che piano si trova?</label>
                                <div class="grid grid-cols-5 gap-2" id="piano-singolo-container"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Condizioni -->
                    <div class="step" data-step="5">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Condizioni</h1>
                        <div class="mb-8" id="stato-group">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Stato di manutenzione</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Da ristrutturare</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Abitabile</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Ristrutturato</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">Nuova Costruzione</button>
                            </div>
                        </div>
                        <div id="classe-group">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Classe Energetica</label>
                            <div class="grid grid-cols-6 gap-2">
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A4</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A3</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A2</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">A</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">B</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">C</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">D</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">E</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">F</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm">G</button>
                                <button type="button" onclick="selectGrid(this)" class="option-btn !p-3 text-center !text-sm col-span-2">Non so</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: Dettagli aggiuntivi -->
                    <div class="step" data-step="6">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-8 text-slate-900">Dettagli aggiuntivi</h1>
                        <div class="space-y-8">
                            <div id="ascensore-box" class="hidden">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Presenza ascensore</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !text-center">S√¨</button>
                                    <button type="button" onclick="selectGrid(this)" class="option-btn !text-center">No</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-widest">Pertinenze incluse</label>
                                <div class="space-y-3">
                                    <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Balcone</span><div class="check-mark"></div></button>
                                    <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Terrazzo</span><div class="check-mark"></div></button>
                                    <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Giardino</span><div class="check-mark"></div></button>
                                    <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Box Auto</span><div class="check-mark"></div></button>
                                    <button type="button" onclick="toggleMultiple(this)" class="option-btn check-option"><span>Cantina</span><div class="check-mark"></div></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 7: Ci siamo quasi -->
                    <div class="step" data-step="7">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-center mb-2 text-slate-900">Ci siamo quasi!</h1>
                        <div class="flex items-center gap-4 p-5 bg-indigo-50/50 rounded-2xl mb-8 border border-indigo-100">
                            <div class="text-3xl">üìä</div>
                            <div class="text-xs text-indigo-900 font-medium leading-relaxed">
                                <strong>Analisi completata!</strong> Abbiamo incrociato i dati con <strong id="random-count">--</strong> immobili simili a <span id="city-placeholder" class="font-bold underline">tua zona</span>.
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <input type="text" id="nome" placeholder="Nome e Cognome">
                            <input type="email" id="email" placeholder="Email">
                            <input type="tel" id="telefono" placeholder="Telefono">
                            
                            <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <input type="checkbox" id="privacy" class="mt-1 w-5 h-5 accent-indigo-600 cursor-pointer shrink-0">
                                <label for="privacy" class="text-xs text-slate-500 leading-relaxed">
                                    Accetto la <a href="#" target="_blank" class="text-indigo-600 font-bold hover:underline">Privacy Policy</a> e acconsento al trattamento dei dati.
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer Nav -->
            <div id="nav-wrapper" class="footer-nav">
                <div class="max-w-2xl mx-auto flex justify-between items-center px-2">
                    <button id="prevBtn" onclick="prevStep()" class="px-8 py-4 font-semibold text-slate-500 hover:text-indigo-600 transition-all text-lg flex items-center gap-2 group">
                        <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> Indietro
                    </button>
                    <button id="nextBtn" onclick="nextStep()" class="btn-gradient px-12 py-4 font-bold text-lg shadow-lg">Avanti</button>
                </div>
            </div>
        </div>

    </main>

<script>
let currentStep = 1;
const totalSteps = 7;
let selectedTipo = "";
let citySelected = "tua zona";
let selectedAddress = "";
let originalRoute = ""; // Via pulita (senza civico)
let googleStreetNumber = ""; // Civico se fornito da Google
let hasCivico = false;
let fullAddressSet = false; // Flag per sapere se l'indirizzo √® gi√† completo

const searchInput = document.getElementById('google-search');
const searchWrapper = document.getElementById('main-search-container');
const civicoContainer = document.getElementById('civico-input-container');
const civicoHint = document.getElementById('civico-hint');
const civicoMainInput = document.getElementById('civico-input-main');

searchInput.addEventListener('focus', () => searchWrapper.classList.add('focused'));
searchInput.addEventListener('blur', () => searchWrapper.classList.remove('focused'));

function loadGoogleMaps() {
    const apiKey = 'AIzaSyB3' + 'FjhPB8MOPvgfWm' + '-Guqk1i2lh1Sie2CA';
    if (window.google && window.google.maps) { initGoogleMaps(); return; }
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;
    script.async = true; script.defer = true;
    script.onload = () => { setTimeout(initGoogleMaps, 100); };
    document.head.appendChild(script);
}

function initGoogleMaps() {
    const mainInput = document.getElementById('google-search');
    const manualInput = document.getElementById('manual-route');
    if (!mainInput || !window.google || !window.google.maps || !window.google.maps.places) return;

    const options = {
        componentRestrictions: { country: "it" },
        fields: ["address_components", "formatted_address"],
        types: ["address"],
    };

    // Inizializzazione Autocomplete Homepage
    const autocompleteMain = new google.maps.places.Autocomplete(mainInput, options);
    setupAutocompleteListener(autocompleteMain, false);

    // Inizializzazione Autocomplete Step 1 (Modifica)
    const autocompleteManual = new google.maps.places.Autocomplete(manualInput, options);
    setupAutocompleteListener(autocompleteManual, true);
}

function setupAutocompleteListener(autocomplete, isManualStep) {
    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place || !place.address_components) return;

        let city = "", province = "", postcode = "", route = "", streetNumber = "";
        
        for (const component of place.address_components) {
            const componentType = component.types[0];
            switch (componentType) {
                case "street_number": streetNumber = component.long_name; break;
                case "route": route = component.long_name; break;
                case "locality": city = component.long_name; break;
                case "administrative_area_level_2": province = component.short_name; break;
                case "postal_code": postcode = component.long_name; break;
            }
        }

        citySelected = city || "tua zona";
        originalRoute = route;
        googleStreetNumber = streetNumber;
        hasCivico = !!streetNumber;

        // Sincronizziamo i valori
        selectedAddress = `${route}${streetNumber ? ' ' + streetNumber : ''}, ${city} ${postcode} (${province})`;
        
        document.getElementById('manual-route').value = route;
        document.getElementById('manual-civico').value = streetNumber;
        document.getElementById('manual-city').value = city;

        if (isManualStep) {
            // Se siamo gi√† nello step 1, restiamo l√¨ finch√© non premono conferma
        } else {
            // Se siamo in home, gestiamo il flow automatico
            if (!hasCivico) {
                showCivicoField();
            } else {
                hideCivicoField();
                fullAddressSet = true;
                civicoMainInput.value = googleStreetNumber;
                setTimeout(() => startValuationFlow(), 300);
            }
        }
    });
}

function showCivicoField() {
    civicoContainer.classList.add('visible');
    civicoHint.classList.remove('hidden');
    civicoMainInput.focus();
}

function hideCivicoField() {
    civicoContainer.classList.remove('visible');
    civicoHint.classList.add('hidden');
}

function confirmManualAddress() {
    const route = document.getElementById('manual-route').value;
    const civico = document.getElementById('manual-civico').value;
    const city = document.getElementById('manual-city').value;
    
    if (!route || !city) return;
    
    selectedAddress = `${route}${civico ? ' ' + civico : ''}, ${city}`;
    citySelected = city;
    document.getElementById('summary-text').innerText = selectedAddress;
    
    currentStep = 2;
    updateUI();
}

function startValuationFlow() {
    const inputVal = searchInput.value;
    const civicoVal = civicoMainInput.value.trim();
    
    if (civicoVal.length > 6) {
        civicoMainInput.classList.add('border-red-400');
        return;
    }

    if (!selectedAddress && inputVal.length > 5) {
        selectedAddress = inputVal;
    } else if (!selectedAddress) {
        return;
    }

    const addressPart = selectedAddress.split(',')[0];
    const hasNumberInAddress = /\d/.test(addressPart);
    
    if (!hasNumberInAddress && !civicoVal) {
        showCivicoField();
        civicoMainInput.classList.add('border-amber-400');
        return;
    }

    if (civicoVal && !hasNumberInAddress) {
        const parts = selectedAddress.split(',');
        selectedAddress = originalRoute + ' ' + civicoVal + ',' + (parts[1] || citySelected);
        searchInput.value = originalRoute + ' ' + civicoVal;
        fullAddressSet = true;
    }
    
    document.getElementById('home-content').classList.add('hidden');
    document.getElementById('form-container').classList.remove('hidden');
    document.getElementById('address-bar').classList.remove('hidden');
    document.getElementById('summary-text').innerText = selectedAddress;
    currentStep = 2;
    updateUI();
}

function resetToHome() {
    document.getElementById('home-content').classList.remove('hidden');
    document.getElementById('form-container').classList.add('hidden');
    document.getElementById('address-bar').classList.add('hidden');
    
    if (fullAddressSet || /\d/.test(searchInput.value)) {
        searchInput.value = originalRoute;
        showCivicoField();
    }
    
    currentStep = 1;
}

function handleSelection(btn, value) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(s => s.classList.remove('selected'));
    btn.classList.add('selected');
    if (currentStep === 2) {
        selectedTipo = value;
        const asc = document.getElementById('ascensore-box');
        if (['villa-indipendente', 'villetta-schiera'].includes(value)) asc.classList.add('hidden');
        else asc.classList.remove('hidden');
    }
    setTimeout(() => { nextStep(); }, 350);
}

function selectGrid(btn) {
    const parent = btn.parentElement;
    parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const stepNum = parseInt(btn.closest('.step').getAttribute('data-step'));
    if (stepNum === 3) {
        if (document.querySelector('#locali-group .selected') && document.querySelector('#bagni-group .selected')) setTimeout(() => nextStep(), 350);
    } else if (stepNum === 5) {
        if (document.querySelector('#stato-group .selected') && document.querySelector('#classe-group .selected')) setTimeout(() => nextStep(), 350);
    }
}

function toggleMultiple(btn) { btn.classList.toggle('selected'); }

function generateTotalePiani() {
    const container = document.getElementById('totale-piani-container');
    if (!container) return;
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-sm';
        btn.innerText = i === 10 ? '10+' : i;
        btn.onclick = () => handleTotalePiani(i, btn);
        container.appendChild(btn);
    }
}

function handleTotalePiani(num, btn) {
    document.getElementById('totale-piani-container').querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const isVilla = ['villa-indipendente', 'villetta-schiera'].includes(selectedTipo);
    const pianoBox = document.getElementById('piano-specifico-box');
    if (isVilla) { pianoBox.classList.add('hidden'); setTimeout(() => nextStep(), 350); }
    else { generatePianoSingolo(num); pianoBox.classList.remove('hidden'); setTimeout(() => pianoBox.classList.add('opacity-100'), 50); }
}

function generatePianoSingolo(max) {
    const container = document.getElementById('piano-singolo-container');
    container.innerHTML = '';
    const limit = max === 10 ? 10 : max;
    for (let i = 0; i <= limit; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option-btn !p-3 text-center !text-sm';
        btn.innerText = i === 0 ? 'T' : (i === 10 ? '10+' : i);
        btn.onclick = () => {
            container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            setTimeout(() => nextStep(), 350);
        };
        container.appendChild(btn);
    }
}

function nextStep() {
    if (currentStep === totalSteps) {
        const n = document.getElementById('nome').value, e = document.getElementById('email').value, p = document.getElementById('privacy').checked;
        if (!n || !e || !p) { return; }
        submitFinalForm();
        return;
    }
    currentStep++; updateUI();
}

function prevStep() { if (currentStep > 1) { currentStep--; updateUI(); } else { resetToHome(); } }

function updateUI() {
    document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active');
        if (parseInt(s.getAttribute('data-step')) === currentStep) s.classList.add('active');
    });
    
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 1) nextBtn.classList.add('hidden');
    else nextBtn.classList.remove('hidden');

    if (currentStep === 7) {
        document.getElementById('random-count').innerText = Math.floor(Math.random() * 9) + 9;
        document.getElementById('city-placeholder').innerText = citySelected;
        nextBtn.innerText = "Ottieni Valutazione";
    } else if (currentStep !== 1) {
        nextBtn.innerText = "Avanti";
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function submitFinalForm() {
    const formData = {
        indirizzo: selectedAddress,
        mq: document.getElementById('mq').value,
        tipo_immobile: selectedTipo,
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        timestamp: new Date().toLocaleString("it-IT")
    };
    const main = document.querySelector('main');
    const nav = document.getElementById('nav-wrapper');
    if (nav) nav.classList.add('hidden');
    main.innerHTML = `<div class="w-full max-w-xl text-center py-20"><div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent mb-6"></div><h2 class="text-2xl font-bold mb-2 text-slate-900">Analisi in corso...</h2></div>`;
    try {
        const response = await fetch("https://hook.eu1.make.com/vypj6pof43fnqb84icw01dkapqjft4s8", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });
        if (response.ok) {
            if (typeof gtag_report_conversion === 'function') gtag_report_conversion();
            main.innerHTML = `<div class="text-center py-20 animate-fadeIn w-full max-w-xl mx-auto bg-white rounded-[2rem] p-10 shadow-lg border border-indigo-50"><h2 class="text-3xl font-black text-indigo-600 mb-4">Ottimo lavoro!</h2><p class="text-slate-600 text-lg">Valutazione inviata. Ti contatteremo a breve.</p><button onclick="location.reload()" class="btn-gradient px-10 py-4 font-bold text-lg mt-10">Torna alla Home</button></div>`;
        } else throw new Error();
    } catch (e) { main.innerHTML = `<div class="text-center py-20 text-red-600 font-bold">Errore di invio dati.</div>`; }
}

window.onload = () => { loadGoogleMaps(); generateTotalePiani(); updateUI(); };
</script>

</body>
</html>
